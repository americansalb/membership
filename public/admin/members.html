<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Members - VillageMembers Admin</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-main { flex: 1; margin-left: var(--sidebar-width); background-color: var(--bg-secondary); }
    @media (max-width: 768px) { .admin-main { margin-left: 0; padding-bottom: 4rem; } }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      background-color: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .admin-content { padding: var(--space-6); max-width: 1400px; }

    /* Search */
    .search-box {
      position: relative;
      width: 320px;
    }
    .search-box input {
      width: 100%;
      padding: var(--space-2) var(--space-3) var(--space-2) 2.5rem;
      font-size: var(--text-sm);
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
    }
    .search-box input:focus {
      background: var(--bg-primary);
      border-color: var(--green-500);
      box-shadow: 0 0 0 3px rgba(74, 124, 74, 0.15);
      outline: none;
    }
    .search-box svg {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--gray-400);
    }
    .search-hint {
      position: absolute;
      right: var(--space-2);
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: var(--gray-400);
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    /* Page Header */
    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-6);
    }
    .page-title { font-size: var(--text-2xl); font-weight: var(--font-bold); }
    .page-subtitle { color: var(--text-secondary); margin-top: var(--space-1); }
    .page-actions { display: flex; gap: var(--space-3); }

    /* Attention Bar */
    .attention-bar {
      background: var(--terra-50);
      border: 1px solid var(--terra-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    .attention-bar.hidden { display: none; }
    .attention-bar svg { color: var(--terra-500); flex-shrink: 0; }
    .attention-bar span { font-size: var(--text-sm); color: var(--terra-700); }
    .attention-bar a { color: var(--terra-600); text-decoration: underline; cursor: pointer; }

    /* Table Card */
    .table-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }
    .table-toolbar {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    .filter-tabs { display: flex; gap: var(--space-1); }
    .filter-tab {
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      background: none;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .filter-tab:hover { color: var(--text-primary); background: var(--bg-secondary); }
    .filter-tab.active { color: var(--green-700); background: var(--green-50); }

    /* Data Table */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      user-select: none;
    }
    .data-table th:hover { color: var(--gray-700); }
    .data-table th.sorted { color: var(--green-600); }
    .data-table td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }
    .data-table tbody tr { cursor: pointer; transition: background var(--transition-fast); }
    .data-table tbody tr:hover { background: var(--green-50); }
    .data-table tbody tr:last-child td { border-bottom: none; }

    /* Member Cell */
    .member-cell { display: flex; align-items: center; gap: var(--space-3); }
    .member-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--green-100) 0%, var(--green-200) 100%);
      color: var(--green-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      flex-shrink: 0;
    }
    .member-info { min-width: 0; }
    .member-name { font-weight: var(--font-medium); color: var(--text-primary); }
    .member-email { font-size: var(--text-xs); color: var(--gray-400); margin-top: 1px; }

    /* Custom Fields Display */
    .custom-field-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px var(--space-2);
      font-size: 10px;
      font-weight: var(--font-medium);
      background: var(--gray-100);
      color: var(--gray-600);
      border-radius: var(--radius-full);
      margin-left: var(--space-1);
    }

    /* Table Footer */
    .table-footer {
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    .pagination { display: flex; gap: 2px; }
    .page-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-sm);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .page-btn:hover:not(:disabled) { border-color: var(--green-500); }
    .page-btn.active { background: var(--green-600); color: white; border-color: var(--green-600); }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: var(--z-modal-backdrop);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }
    .modal-backdrop.active { opacity: 1; visibility: visible; }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -48%);
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 480px;
      max-width: calc(100% - var(--space-8));
      max-height: calc(100vh - var(--space-8));
      z-index: var(--z-modal);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }
    .modal.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%); }
    .modal.lg { width: 640px; }

    /* Slide Panel */
    .slide-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 560px;
      max-width: 100%;
      background: var(--bg-primary);
      box-shadow: var(--shadow-xl);
      z-index: var(--z-modal);
      transform: translateX(100%);
      transition: transform var(--transition-slow);
      display: flex;
      flex-direction: column;
    }
    .slide-panel.active { transform: translateX(0); }
    .panel-header {
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-body { flex: 1; overflow-y: auto; padding: var(--space-6); }

    /* Member Detail */
    .detail-header { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-6); }
    .detail-avatar {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--green-100) 0%, var(--green-200) 100%);
      color: var(--green-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
    }
    .detail-name { font-size: var(--text-xl); font-weight: var(--font-semibold); }
    .detail-email { font-size: var(--text-sm); color: var(--text-secondary); margin-top: 2px; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: var(--space-4); }
    .tab-btn {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active { color: var(--green-600); }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--green-600);
    }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    /* Detail Sections */
    .detail-section { margin-bottom: var(--space-6); }
    .detail-section-title {
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gray-400);
      margin-bottom: var(--space-3);
    }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); }
    .detail-label { font-size: var(--text-xs); color: var(--gray-400); margin-bottom: 2px; }
    .detail-value { font-size: var(--text-sm); color: var(--text-primary); }

    /* Custom Fields Section */
    .custom-fields-section { margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-color); }
    .custom-field-row { display: flex; justify-content: space-between; padding: var(--space-2) 0; border-bottom: 1px solid var(--gray-100); }
    .custom-field-row:last-child { border-bottom: none; }

    /* Timeline */
    .timeline { position: relative; padding-left: var(--space-6); }
    .timeline::before {
      content: '';
      position: absolute;
      left: 5px;
      top: 4px;
      bottom: 4px;
      width: 2px;
      background: var(--gray-200);
    }
    .timeline-item { position: relative; padding-bottom: var(--space-4); }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: calc(-1 * var(--space-6) + 1px);
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: var(--radius-full);
      background: var(--bg-primary);
      border: 2px solid var(--green-500);
    }
    .timeline-date { font-size: var(--text-xs); color: var(--gray-400); }
    .timeline-text { font-size: var(--text-sm); color: var(--text-primary); }

    /* Notes */
    .note {
      background: var(--green-50);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      margin-bottom: var(--space-2);
    }
    .note-header { display: flex; justify-content: space-between; margin-bottom: var(--space-1); }
    .note-author { font-size: var(--text-xs); font-weight: var(--font-medium); }
    .note-date { font-size: var(--text-xs); color: var(--gray-400); }
    .note-text { font-size: var(--text-sm); }

    /* Import Dropzone */
    .dropzone {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .dropzone:hover, .dropzone.dragover {
      border-color: var(--green-500);
      background: var(--green-50);
    }
    .dropzone-icon { width: 40px; height: 40px; color: var(--gray-400); margin: 0 auto var(--space-3); }
    .dropzone-text { font-size: var(--text-sm); color: var(--text-secondary); }
    .dropzone-text strong { color: var(--green-600); }

    /* Template Download Link */
    .template-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      margin-top: var(--space-3);
      font-size: var(--text-sm);
      color: var(--green-600);
      cursor: pointer;
    }
    .template-link:hover { text-decoration: underline; }

    /* Import Preview */
    .import-preview { margin-top: var(--space-4); }
    .preview-table { width: 100%; font-size: var(--text-sm); border: 1px solid var(--border-color); border-radius: var(--radius-lg); overflow: hidden; }
    .preview-table th, .preview-table td { padding: var(--space-2) var(--space-3); text-align: left; border-bottom: 1px solid var(--border-color); }
    .preview-table th { background: var(--bg-secondary); font-weight: var(--font-medium); color: var(--gray-500); }
    .mapping { margin-top: var(--space-4); }
    .mapping-row { display: grid; grid-template-columns: 1fr auto 1fr; gap: var(--space-3); align-items: center; padding: var(--space-2) 0; border-bottom: 1px solid var(--border-color); }
    .mapping-arrow { color: var(--gray-400); }

    /* Duplicate Warning */
    .dup-warning {
      background: var(--terra-50);
      border: 1px solid var(--terra-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      display: flex;
      gap: var(--space-3);
    }
    .dup-warning svg { color: var(--terra-500); flex-shrink: 0; margin-top: 2px; }
    .dup-warning-text { font-size: var(--text-sm); color: var(--terra-700); }
    .dup-warning-actions { display: flex; gap: var(--space-2); margin-top: var(--space-2); }

    /* Command Palette */
    .cmd-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 600;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
    }
    .cmd-backdrop.active { opacity: 1; visibility: visible; }
    .cmd-palette {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%) scale(0.98);
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 560px;
      max-width: calc(100% - var(--space-8));
      z-index: 601;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
    }
    .cmd-palette.active { opacity: 1; visibility: visible; transform: translateX(-50%) scale(1); }
    .cmd-input {
      width: 100%;
      padding: var(--space-4);
      font-size: var(--text-lg);
      border: none;
      border-bottom: 1px solid var(--border-color);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }
    .cmd-input:focus { outline: none; }
    .cmd-results { max-height: 320px; overflow-y: auto; padding: var(--space-2); }
    .cmd-section { padding: var(--space-2) var(--space-3); font-size: var(--text-xs); font-weight: var(--font-medium); text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-400); }
    .cmd-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); cursor: pointer; }
    .cmd-item:hover { background: var(--green-50); }

    /* Toasts */
    .toast-container { position: fixed; bottom: var(--space-4); right: var(--space-4); z-index: var(--z-toast); display: flex; flex-direction: column; gap: var(--space-2); }
    .toast-item {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      animation: slideIn 0.3s ease;
    }
    .toast-item.success { border-left: 3px solid var(--success); }
    .toast-item.error { border-left: 3px solid var(--error); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Mobile */
    @media (max-width: 768px) {
      .search-box { width: 180px; }
      .search-hint { display: none; }
      .page-header { flex-direction: column; gap: var(--space-4); }
      .slide-panel { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <a href="/admin/" style="color: white; font-size: var(--text-xl); font-weight: var(--font-bold);">VillageMembers</a>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
          Dashboard
        </a>
        <a href="/admin/members.html" class="sidebar-link active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          Members
        </a>
        <a href="/admin/tiers.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
          Tiers
        </a>
        <div class="sidebar-section">Credentials & CEU</div>
        <a href="/admin/credentials.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
          Credentials
        </a>
        <a href="/admin/ceu-credits.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
          Review Credits
        </a>
        <div class="sidebar-section">Settings</div>
        <a href="/admin/settings.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <div class="search-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input type="text" placeholder="Search members..." id="searchInput">
          <span class="search-hint">⌘K</span>
        </div>
        <div class="flex items-center gap-4">
          <span id="userName" class="text-sm"></span>
          <button onclick="logout()" class="btn btn-ghost btn-sm">Logout</button>
        </div>
      </header>

      <div class="admin-content">
        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title">Members</h1>
            <p class="page-subtitle" id="memberCount">Loading...</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" id="exportBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export
            </button>
            <button class="btn btn-secondary" id="importBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Import
            </button>
            <button class="btn btn-primary" id="addBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Member
            </button>
          </div>
        </div>

        <!-- Attention Bar -->
        <div class="attention-bar hidden" id="attentionBar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          <span id="attentionText"></span>
        </div>

        <!-- Table Card -->
        <div class="table-card">
          <div class="table-toolbar">
            <div class="filter-tabs">
              <button class="filter-tab active" data-filter="all">All</button>
              <button class="filter-tab" data-filter="active">Active</button>
              <button class="filter-tab" data-filter="expiring">Expiring Soon</button>
              <button class="filter-tab" data-filter="expired">Expired</button>
              <button class="filter-tab" data-filter="pending">Pending</button>
            </div>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th data-sort="name" class="sorted">Member</th>
                <th data-sort="status">Status</th>
                <th data-sort="tier">Tier</th>
                <th data-sort="phone">Phone</th>
                <th data-sort="expires">Expires</th>
                <th data-sort="joined">Joined</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="6" class="table-empty">Loading...</td></tr>
            </tbody>
          </table>

          <div class="table-footer">
            <span id="tableInfo">-</span>
            <div class="pagination" id="pagination"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
      <a href="/admin/" class="bottom-nav-link">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
        Home
      </a>
      <a href="/admin/members.html" class="bottom-nav-link active">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
        Members
      </a>
      <a href="/admin/settings.html" class="bottom-nav-link">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        Settings
      </a>
    </nav>
  </div>

  <!-- Command Palette -->
  <div class="cmd-backdrop" id="cmdBackdrop"></div>
  <div class="cmd-palette" id="cmdPalette">
    <input type="text" class="cmd-input" id="cmdInput" placeholder="Search members or actions...">
    <div class="cmd-results" id="cmdResults"></div>
  </div>

  <!-- Add Member Modal -->
  <div class="modal-backdrop" id="addBackdrop"></div>
  <div class="modal" id="addModal">
    <div class="modal-header">
      <h3 class="modal-title">Add Member</h3>
      <button class="modal-close" onclick="closeAdd()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="dup-warning" id="dupWarning" style="display:none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <div>
          <div class="dup-warning-text" id="dupText"></div>
          <div class="dup-warning-actions">
            <button class="btn btn-sm btn-secondary" onclick="viewDup()">View existing</button>
            <button class="btn btn-sm btn-ghost" onclick="ignoreDup()">Add anyway</button>
          </div>
        </div>
      </div>
      <form id="addForm" onsubmit="submitAdd(event)">
        <div class="form-group" style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4)">
          <div>
            <label class="label">First Name *</label>
            <input type="text" class="input" name="first_name" required>
          </div>
          <div>
            <label class="label">Last Name *</label>
            <input type="text" class="input" name="last_name" required>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Email *</label>
          <input type="email" class="input" name="email" id="addEmail" required>
        </div>
        <div class="form-group">
          <label class="label">Phone</label>
          <input type="tel" class="input" name="phone" id="addPhone">
        </div>
        <div class="form-group" style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4)">
          <div>
            <label class="label">Tier</label>
            <select class="input" name="tier_id" id="addTier">
              <option value="">Select tier...</option>
            </select>
          </div>
          <div>
            <label class="label">Status</label>
            <select class="input" name="status">
              <option value="active">Active</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Expiration Date</label>
          <input type="date" class="input" name="expires_at">
        </div>
        <div id="customFieldsForm"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeAdd()">Cancel</button>
      <button type="submit" form="addForm" class="btn btn-primary">Add Member</button>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal-backdrop" id="importBackdrop"></div>
  <div class="modal lg" id="importModal">
    <div class="modal-header">
      <h3 class="modal-title">Import Members</h3>
      <button class="modal-close" onclick="closeImport()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="dropzone" id="dropzone">
        <svg class="dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
        <p class="dropzone-text"><strong>Click to upload</strong> or drag a CSV file here</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
      </div>
      <div class="template-link" onclick="downloadTemplate()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download import template
      </div>
      <div id="importPreview" class="import-preview" style="display:none">
        <p style="font-weight:var(--font-medium);margin-bottom:var(--space-2)" id="previewCount"></p>
        <table class="preview-table">
          <thead id="previewHead"></thead>
          <tbody id="previewBody"></tbody>
        </table>
        <div class="mapping">
          <p class="detail-section-title">Column Mapping</p>
          <div id="mappingRows"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeImport()">Cancel</button>
      <button type="button" class="btn btn-primary" id="importConfirm" disabled onclick="doImport()">Import Members</button>
    </div>
  </div>

  <!-- Member Detail Panel -->
  <div class="modal-backdrop" id="panelBackdrop"></div>
  <div class="slide-panel" id="memberPanel">
    <div class="panel-header">
      <h3 class="modal-title">Member Details</h3>
      <button class="modal-close" onclick="closePanel()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="panel-body">
      <div class="detail-header">
        <div class="detail-avatar" id="panelAvatar">?</div>
        <div>
          <div class="detail-name" id="panelName">-</div>
          <div class="detail-email" id="panelEmail">-</div>
          <div style="margin-top:var(--space-2)"><span class="badge badge-success" id="panelStatus">-</span></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="profile">Profile</button>
        <button class="tab-btn" data-tab="timeline">Activity</button>
        <button class="tab-btn" data-tab="notes">Notes</button>
      </div>

      <div class="tab-pane active" id="tab-profile">
        <div class="detail-section">
          <div class="detail-section-title">Contact Information</div>
          <div class="detail-grid">
            <div><div class="detail-label">Email</div><div class="detail-value" id="pEmail">-</div></div>
            <div><div class="detail-label">Phone</div><div class="detail-value" id="pPhone">-</div></div>
          </div>
        </div>
        <div class="detail-section">
          <div class="detail-section-title">Membership</div>
          <div class="detail-grid">
            <div><div class="detail-label">Tier</div><div class="detail-value" id="pTier">-</div></div>
            <div><div class="detail-label">Status</div><div class="detail-value" id="pStatus">-</div></div>
            <div><div class="detail-label">Member Since</div><div class="detail-value" id="pJoined">-</div></div>
            <div><div class="detail-label">Expires</div><div class="detail-value" id="pExpires">-</div></div>
          </div>
        </div>
        <div class="detail-section" id="customFieldsDisplay"></div>
        <div style="margin-top:var(--space-6);display:flex;gap:var(--space-2)">
          <a id="editLink" class="btn btn-secondary btn-sm">Edit Full Profile</a>
          <button class="btn btn-ghost btn-sm" style="color:var(--error)" onclick="deleteMember()">Delete</button>
        </div>
      </div>

      <div class="tab-pane" id="tab-timeline">
        <div class="timeline" id="timeline"></div>
      </div>

      <div class="tab-pane" id="tab-notes">
        <div id="notesContainer"><p class="text-muted">No notes yet</p></div>
        <div style="margin-top:var(--space-4)">
          <textarea class="input" id="noteInput" rows="3" placeholder="Add a note..."></textarea>
          <button class="btn btn-primary btn-sm" style="margin-top:var(--space-2)" onclick="addNote()">Add Note</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toasts"></div>

  <script src="/js/app.js"></script>
  <script>
    // State
    const state = {
      members: [],
      filtered: [],
      tiers: [],
      customFields: [],
      filter: 'all',
      sort: 'name',
      sortDir: 'asc',
      search: '',
      page: 1,
      perPage: 25,
      selected: null,
      importData: null,
      importMap: {},
      dup: null,
      ignoreDup: false
    };

    const $ = id => document.getElementById(id);

    // Init
    async function init() {
      const ok = await checkAuth();
      if (!ok) return;
      const [members, tiers] = await Promise.all([fetchMembers(), fetchTiers()]);
      state.members = members;
      state.tiers = tiers;
      applyFilter();
      renderAttention();
      setupEvents();
    }

    // Auth
    async function checkAuth() {
      try {
        const r = await fetch('/auth/me?type=user', { credentials: 'include' });
        if (!r.ok) { location.href = '/login'; return false; }
        const d = await r.json();
        if (d.type !== 'user') { location.href = '/login'; return false; }
        $('userName').textContent = d.name || d.email || '';
        return true;
      } catch { location.href = '/login'; return false; }
    }

    async function logout() {
      await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      location.href = '/login';
    }

    // API
    async function fetchMembers() {
      try {
        const r = await fetch('/api/v1/members?limit=1000', { credentials: 'include' });
        const d = await r.json();
        return d.members || [];
      } catch { return []; }
    }

    async function fetchTiers() {
      try {
        const r = await fetch('/api/v1/tiers', { credentials: 'include' });
        const d = await r.json();
        return d.tiers || [];
      } catch { return []; }
    }

    // Helpers
    const initials = (f, l) => `${(f||'')[0]||''}${(l||'')[0]||''}`.toUpperCase() || '?';
    const fmtDate = d => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-';
    const fmtPhone = p => p || '-';

    function getStatusInfo(status, expiresAt) {
      if (status === 'expired') return { class: 'badge-error', label: 'Expired' };
      if (status === 'pending') return { class: 'badge-default', label: 'Pending' };
      if (expiresAt) {
        const days = Math.ceil((new Date(expiresAt) - new Date()) / 86400000);
        if (days <= 0) return { class: 'badge-error', label: 'Expired' };
        if (days <= 30) return { class: 'badge-warning', label: `Expires in ${days}d` };
      }
      return { class: 'badge-success', label: 'Active' };
    }

    function toast(msg, type = 'success') {
      const t = document.createElement('div');
      t.className = `toast-item ${type}`;
      t.textContent = msg;
      $('toasts').appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }

    // Filter & Sort
    function applyFilter() {
      let arr = [...state.members];
      const now = new Date();

      if (state.filter === 'active') arr = arr.filter(m => m.status === 'active');
      else if (state.filter === 'expired') arr = arr.filter(m => m.status === 'expired');
      else if (state.filter === 'pending') arr = arr.filter(m => m.status === 'pending');
      else if (state.filter === 'expiring') {
        arr = arr.filter(m => {
          if (!m.expires_at || m.status !== 'active') return false;
          const d = Math.ceil((new Date(m.expires_at) - now) / 86400000);
          return d <= 30 && d > 0;
        });
      }

      if (state.search) {
        const q = state.search.toLowerCase();
        arr = arr.filter(m =>
          [m.first_name, m.last_name, m.email, m.phone, m.tier_name]
            .filter(Boolean).join(' ').toLowerCase().includes(q)
        );
      }

      arr.sort((a, b) => {
        let av, bv;
        if (state.sort === 'name') {
          av = `${a.first_name||''} ${a.last_name||''}`;
          bv = `${b.first_name||''} ${b.last_name||''}`;
        } else {
          av = a[state.sort] || '';
          bv = b[state.sort] || '';
        }
        if (typeof av === 'string') { av = av.toLowerCase(); bv = bv.toLowerCase(); }
        if (av < bv) return state.sortDir === 'asc' ? -1 : 1;
        if (av > bv) return state.sortDir === 'asc' ? 1 : -1;
        return 0;
      });

      state.filtered = arr;
      state.page = 1;
      render();
    }

    function render() {
      const start = (state.page - 1) * state.perPage;
      const end = start + state.perPage;
      const slice = state.filtered.slice(start, end);

      if (slice.length === 0) {
        $('tableBody').innerHTML = `<tr><td colspan="6" class="table-empty">
          <div style="padding:var(--space-8);text-align:center">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto var(--space-4);opacity:0.3"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <p style="font-weight:var(--font-medium)">No members found</p>
            <p style="color:var(--text-secondary);font-size:var(--text-sm)">Try adjusting your filters or search</p>
          </div>
        </td></tr>`;
      } else {
        $('tableBody').innerHTML = slice.map(m => {
          const status = getStatusInfo(m.status, m.expires_at);
          const hasCustomFields = m.custom_fields && Object.keys(m.custom_fields).length > 0;
          return `
            <tr onclick="openPanel('${m.id}')">
              <td>
                <div class="member-cell">
                  <div class="member-avatar">${initials(m.first_name, m.last_name)}</div>
                  <div class="member-info">
                    <div class="member-name">${m.first_name||''} ${m.last_name||''}${hasCustomFields ? '<span class="custom-field-badge">+fields</span>' : ''}</div>
                    <div class="member-email">${m.email||''}</div>
                  </div>
                </div>
              </td>
              <td><span class="badge ${status.class}">${status.label}</span></td>
              <td>${m.tier_name||'<span style="color:var(--gray-400)">No tier</span>'}</td>
              <td>${fmtPhone(m.phone)}</td>
              <td>${fmtDate(m.expires_at)}</td>
              <td>${fmtDate(m.created_at)}</td>
            </tr>
          `;
        }).join('');
      }

      const total = state.filtered.length;
      $('tableInfo').textContent = total > 0 ? `Showing ${start+1}–${Math.min(end, total)} of ${total}` : 'No results';
      $('memberCount').textContent = `${state.members.length} total members`;
      renderPagination(total);
    }

    function renderPagination(total) {
      const pages = Math.ceil(total / state.perPage);
      if (pages <= 1) { $('pagination').innerHTML = ''; return; }

      let h = `<button class="page-btn" ${state.page===1?'disabled':''} onclick="goPage(${state.page-1})">←</button>`;
      for (let i = 1; i <= pages; i++) {
        if (i === 1 || i === pages || (i >= state.page-1 && i <= state.page+1)) {
          h += `<button class="page-btn ${i===state.page?'active':''}" onclick="goPage(${i})">${i}</button>`;
        } else if (i === state.page-2 || i === state.page+2) {
          h += `<span style="padding:0 4px;color:var(--gray-400)">...</span>`;
        }
      }
      h += `<button class="page-btn" ${state.page===pages?'disabled':''} onclick="goPage(${state.page+1})">→</button>`;
      $('pagination').innerHTML = h;
    }

    function goPage(p) { state.page = p; render(); }

    function renderAttention() {
      const now = new Date();
      const expired = state.members.filter(m => m.status === 'expired').length;
      const expiring = state.members.filter(m => {
        if (!m.expires_at || m.status !== 'active') return false;
        const d = Math.ceil((new Date(m.expires_at) - now) / 86400000);
        return d <= 30 && d > 0;
      }).length;

      if (expired === 0 && expiring === 0) {
        $('attentionBar').classList.add('hidden');
      } else {
        $('attentionBar').classList.remove('hidden');
        let parts = [];
        if (expiring) parts.push(`<a onclick="setFilter('expiring')">${expiring} expiring soon</a>`);
        if (expired) parts.push(`<a onclick="setFilter('expired')">${expired} expired</a>`);
        $('attentionText').innerHTML = parts.join(' and ') + ' need attention';
      }
    }

    function setFilter(f) {
      state.filter = f;
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.filter === f));
      applyFilter();
    }

    function setSort(col) {
      if (state.sort === col) state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
      else { state.sort = col; state.sortDir = 'asc'; }
      document.querySelectorAll('.data-table th').forEach(th => th.classList.toggle('sorted', th.dataset.sort === col));
      applyFilter();
    }

    // Command Palette
    function openCmd() { $('cmdBackdrop').classList.add('active'); $('cmdPalette').classList.add('active'); $('cmdInput').value = ''; $('cmdInput').focus(); renderCmd(''); }
    function closeCmd() { $('cmdBackdrop').classList.remove('active'); $('cmdPalette').classList.remove('active'); }

    function renderCmd(q) {
      const lq = q.toLowerCase();
      const members = state.members.filter(m => `${m.first_name||''} ${m.last_name||''} ${m.email||''}`.toLowerCase().includes(lq)).slice(0, 5);
      const actions = [{ t: 'Add new member', a: 'add' }, { t: 'Export to CSV', a: 'export' }, { t: 'Import from CSV', a: 'import' }].filter(x => x.t.toLowerCase().includes(lq));

      let h = '';
      if (members.length) {
        h += '<div class="cmd-section">Members</div>';
        members.forEach(m => {
          h += `<div class="cmd-item" onclick="openPanel('${m.id}');closeCmd()">
            <div class="member-avatar" style="width:28px;height:28px;font-size:10px">${initials(m.first_name, m.last_name)}</div>
            <div><div style="font-weight:var(--font-medium)">${m.first_name||''} ${m.last_name||''}</div><div style="font-size:var(--text-xs);color:var(--gray-400)">${m.email||''}</div></div>
          </div>`;
        });
      }
      if (actions.length) {
        h += '<div class="cmd-section">Actions</div>';
        actions.forEach(a => {
          h += `<div class="cmd-item" onclick="doAction('${a.a}');closeCmd()"><div>${a.t}</div></div>`;
        });
      }
      if (!h) h = '<div style="padding:var(--space-6);text-align:center;color:var(--gray-400)">No results</div>';
      $('cmdResults').innerHTML = h;
    }

    function doAction(a) {
      if (a === 'add') openAdd();
      else if (a === 'export') exportCSV();
      else if (a === 'import') openImport();
    }

    // Add Modal
    function openAdd() {
      $('addBackdrop').classList.add('active');
      $('addModal').classList.add('active');
      $('addForm').reset();
      $('dupWarning').style.display = 'none';
      state.ignoreDup = false;
      state.dup = null;
      $('addTier').innerHTML = '<option value="">Select tier...</option>' + state.tiers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function closeAdd() { $('addBackdrop').classList.remove('active'); $('addModal').classList.remove('active'); }

    function checkDup() {
      if (state.ignoreDup) return;
      const email = $('addEmail').value.toLowerCase().trim();
      const phone = $('addPhone').value.replace(/\D/g, '');

      for (const m of state.members) {
        if (email && (m.email||'').toLowerCase() === email) {
          state.dup = m;
          $('dupText').textContent = `A member with this email already exists: ${m.first_name} ${m.last_name}`;
          $('dupWarning').style.display = 'flex';
          return;
        }
        if (phone.length >= 10 && (m.phone||'').replace(/\D/g, '') === phone) {
          state.dup = m;
          $('dupText').textContent = `A member with this phone already exists: ${m.first_name} ${m.last_name}`;
          $('dupWarning').style.display = 'flex';
          return;
        }
      }
      state.dup = null;
      $('dupWarning').style.display = 'none';
    }

    function viewDup() { if (state.dup) { closeAdd(); openPanel(state.dup.id); } }
    function ignoreDup() { state.ignoreDup = true; $('dupWarning').style.display = 'none'; }

    async function submitAdd(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd);
      Object.keys(data).forEach(k => { if (!data[k]) delete data[k]; });

      try {
        const r = await fetch('/api/v1/members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if (!r.ok) { const e = await r.json(); throw new Error(e.error); }
        toast('Member added successfully');
        closeAdd();
        state.members = await fetchMembers();
        applyFilter();
        renderAttention();
      } catch (e) { toast(e.message, 'error'); }
    }

    // Import Modal
    function openImport() {
      $('importBackdrop').classList.add('active');
      $('importModal').classList.add('active');
      resetImport();
    }

    function closeImport() { $('importBackdrop').classList.remove('active'); $('importModal').classList.remove('active'); }

    function resetImport() {
      state.importData = null;
      state.importMap = {};
      $('dropzone').style.display = 'block';
      $('importPreview').style.display = 'none';
      $('importConfirm').disabled = true;
      $('fileInput').value = '';
    }

    function downloadTemplate() {
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Status', 'Expires'];
      const example = ['John', 'Doe', 'john@example.com', '555-123-4567', 'active', '2025-12-31'];
      const csv = [headers.join(','), example.join(',')].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = 'member-import-template.csv';
      a.click();
      toast('Template downloaded');
    }

    function parseCSV(txt) {
      const lines = txt.split('\n').filter(l => l.trim());
      if (lines.length < 2) return { h: [], r: [] };
      const parse = line => {
        const a = []; let c = '', q = false;
        for (let i = 0; i < line.length; i++) {
          if (line[i] === '"') q = !q;
          else if (line[i] === ',' && !q) { a.push(c.trim()); c = ''; }
          else c += line[i];
        }
        a.push(c.trim());
        return a;
      };
      return { h: parse(lines[0]), r: lines.slice(1).map(parse) };
    }

    function handleFile(f) {
      if (!f || !f.name.endsWith('.csv')) { toast('Please select a CSV file', 'error'); return; }
      const reader = new FileReader();
      reader.onload = e => {
        const { h, r } = parseCSV(e.target.result);
        if (!h.length || !r.length) { toast('Invalid CSV file', 'error'); return; }
        state.importData = { h, r };
        showImportPreview();
      };
      reader.readAsText(f);
    }

    function showImportPreview() {
      const { h, r } = state.importData;
      $('dropzone').style.display = 'none';
      $('importPreview').style.display = 'block';
      $('previewCount').textContent = `${r.length} rows found`;
      $('previewHead').innerHTML = `<tr>${h.map(x => `<th>${x}</th>`).join('')}</tr>`;
      $('previewBody').innerHTML = r.slice(0, 3).map(row => `<tr>${row.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');

      const fields = [
        { k: 'first_name', l: 'First Name' },
        { k: 'last_name', l: 'Last Name' },
        { k: 'email', l: 'Email' },
        { k: 'phone', l: 'Phone' },
        { k: 'status', l: 'Status' },
        { k: 'expires_at', l: 'Expires' }
      ];

      // Auto-map columns
      h.forEach((col, i) => {
        const cl = col.toLowerCase().replace(/[^a-z]/g, '');
        for (const f of fields) {
          const fl = f.l.toLowerCase().replace(/[^a-z]/g, '');
          if (cl.includes(fl) || fl.includes(cl)) { state.importMap[i] = f.k; break; }
        }
      });

      $('mappingRows').innerHTML = h.map((col, i) => `
        <div class="mapping-row">
          <span style="font-weight:var(--font-medium)">${col}</span>
          <span class="mapping-arrow">→</span>
          <select class="input" onchange="state.importMap[${i}]=this.value;checkImportReady()">
            <option value="">Skip this column</option>
            ${fields.map(f => `<option value="${f.k}" ${state.importMap[i]===f.k?'selected':''}>${f.l}</option>`).join('')}
          </select>
        </div>
      `).join('');
      checkImportReady();
    }

    function checkImportReady() { $('importConfirm').disabled = !Object.values(state.importMap).includes('email'); }

    async function doImport() {
      if (!state.importData) return;
      const { h, r } = state.importData;
      const members = r.map(row => {
        const m = {};
        h.forEach((_, i) => { const k = state.importMap[i]; if (k && row[i]) m[k] = row[i]; });
        return m;
      }).filter(m => m.email);

      if (!members.length) { toast('No valid rows to import', 'error'); return; }

      try {
        const res = await fetch('/api/v1/members/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ members })
        });
        const d = await res.json();
        toast(`Imported ${d.imported} members${d.skipped ? `, ${d.skipped} skipped` : ''}`);
        closeImport();
        state.members = await fetchMembers();
        applyFilter();
        renderAttention();
      } catch { toast('Import failed', 'error'); }
    }

    // Member Panel
    function openPanel(id) {
      const m = state.members.find(x => x.id == id);
      if (!m) return;
      state.selected = m;

      $('panelBackdrop').classList.add('active');
      $('memberPanel').classList.add('active');

      $('panelAvatar').textContent = initials(m.first_name, m.last_name);
      $('panelName').textContent = `${m.first_name||''} ${m.last_name||''}`;
      $('panelEmail').textContent = m.email || '';

      const status = getStatusInfo(m.status, m.expires_at);
      $('panelStatus').className = `badge ${status.class}`;
      $('panelStatus').textContent = status.label;

      $('pEmail').textContent = m.email || '-';
      $('pPhone').textContent = m.phone || '-';
      $('pTier').textContent = m.tier_name || '-';
      $('pStatus').textContent = m.status || '-';
      $('pJoined').textContent = fmtDate(m.created_at);
      $('pExpires').textContent = fmtDate(m.expires_at);
      $('editLink').href = `/admin/member.html?id=${m.id}`;

      // Custom fields
      if (m.custom_fields && Object.keys(m.custom_fields).length > 0) {
        $('customFieldsDisplay').innerHTML = `
          <div class="detail-section-title">Additional Information</div>
          ${Object.entries(m.custom_fields).map(([k, v]) => `
            <div class="custom-field-row">
              <span class="detail-label">${k}</span>
              <span class="detail-value">${v}</span>
            </div>
          `).join('')}
        `;
      } else {
        $('customFieldsDisplay').innerHTML = '';
      }

      switchTab('profile');
      $('timeline').innerHTML = `<div class="timeline-item"><div class="timeline-date">${fmtDate(m.created_at)}</div><div class="timeline-text">Joined the organization</div></div>`;
    }

    function closePanel() { $('panelBackdrop').classList.remove('active'); $('memberPanel').classList.remove('active'); state.selected = null; }

    function switchTab(t) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === t));
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.toggle('active', p.id === `tab-${t}`));
    }

    async function deleteMember() {
      if (!state.selected || !confirm(`Are you sure you want to delete ${state.selected.first_name} ${state.selected.last_name}?`)) return;
      try {
        const r = await fetch(`/api/v1/members/${state.selected.id}`, { method: 'DELETE', credentials: 'include' });
        if (r.ok) {
          toast('Member deleted');
          closePanel();
          state.members = await fetchMembers();
          applyFilter();
          renderAttention();
        } else { toast('Failed to delete member', 'error'); }
      } catch { toast('Failed to delete member', 'error'); }
    }

    function addNote() {
      const txt = $('noteInput').value.trim();
      if (!txt) return;
      const container = $('notesContainer');
      if (container.querySelector('p.text-muted')) container.innerHTML = '';
      container.insertAdjacentHTML('afterbegin', `
        <div class="note">
          <div class="note-header"><span class="note-author">You</span><span class="note-date">${fmtDate(new Date())}</span></div>
          <div class="note-text">${txt}</div>
        </div>
      `);
      $('noteInput').value = '';
      toast('Note added');
    }

    // Export
    function exportCSV() {
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Status', 'Tier', 'Joined', 'Expires'];
      const rows = state.filtered.map(m => [
        m.first_name || '',
        m.last_name || '',
        m.email || '',
        m.phone || '',
        m.status || '',
        m.tier_name || '',
        m.created_at?.split('T')[0] || '',
        m.expires_at?.split('T')[0] || ''
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = `members-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      toast(`Exported ${state.filtered.length} members`);
    }

    // Events
    function setupEvents() {
      $('searchInput').addEventListener('input', e => { state.search = e.target.value; applyFilter(); });

      document.addEventListener('keydown', e => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openCmd(); }
        if (e.key === 'Escape') { closeCmd(); closeAdd(); closeImport(); closePanel(); }
      });

      $('cmdBackdrop').onclick = closeCmd;
      $('cmdInput').addEventListener('input', e => renderCmd(e.target.value));

      document.querySelectorAll('.filter-tab').forEach(t => t.onclick = () => setFilter(t.dataset.filter));
      document.querySelectorAll('.data-table th[data-sort]').forEach(th => th.onclick = () => setSort(th.dataset.sort));
      document.querySelectorAll('.tab-btn').forEach(t => t.onclick = () => switchTab(t.dataset.tab));

      $('addBtn').onclick = openAdd;
      $('exportBtn').onclick = exportCSV;
      $('importBtn').onclick = openImport;

      $('addBackdrop').onclick = closeAdd;
      $('importBackdrop').onclick = closeImport;
      $('panelBackdrop').onclick = closePanel;

      $('addEmail').addEventListener('blur', checkDup);
      $('addPhone').addEventListener('blur', checkDup);

      $('dropzone').onclick = () => $('fileInput').click();
      $('fileInput').onchange = e => { if (e.target.files.length) handleFile(e.target.files[0]); };
      $('dropzone').ondragover = e => { e.preventDefault(); $('dropzone').classList.add('dragover'); };
      $('dropzone').ondragleave = () => $('dropzone').classList.remove('dragover');
      $('dropzone').ondrop = e => { e.preventDefault(); $('dropzone').classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); };
    }

    init();
  </script>
</body>
</html>
