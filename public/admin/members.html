<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Members - VillageMembers</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    /*
     * Sacred Proportions
     * φ (phi) = 1.618 - The golden ratio
     * Using φ to create harmonious spacing relationships
     */
    :root {
      --phi: 1.618;
      --space-phi-xs: 5px;   /* base */
      --space-phi-sm: 8px;   /* 5 × 1.618 ≈ 8 */
      --space-phi-md: 13px;  /* 8 × 1.618 ≈ 13 */
      --space-phi-lg: 21px;  /* 13 × 1.618 ≈ 21 */
      --space-phi-xl: 34px;  /* 21 × 1.618 ≈ 34 */
      --space-phi-2xl: 55px; /* 34 × 1.618 ≈ 55 */
    }

    /* Layout */
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-main {
      flex: 1;
      margin-left: var(--sidebar-width);
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--green-50) 100%);
      min-height: 100vh;
    }
    @media (max-width: 768px) {
      .admin-main { margin-left: 0; padding-bottom: 5rem; }
    }

    /* Header - Refined */
    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-lg) var(--space-phi-xl);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 40;
    }

    .search-container { position: relative; }
    .search-input {
      width: 280px;
      padding: var(--space-phi-sm) var(--space-phi-md);
      padding-left: 40px;
      font-size: var(--text-sm);
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: var(--radius-full);
      transition: all 0.2s ease;
    }
    .search-input:focus {
      width: 340px;
      background: var(--bg-primary);
      border-color: var(--green-400);
      box-shadow: 0 0 0 4px var(--green-50);
      outline: none;
    }
    .search-icon {
      position: absolute;
      left: var(--space-phi-md);
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--gray-400);
      pointer-events: none;
    }
    .search-shortcut {
      position: absolute;
      right: var(--space-phi-sm);
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: var(--gray-400);
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-family: system-ui;
    }

    .header-actions { display: flex; align-items: center; gap: var(--space-phi-md); }

    /* Content Area */
    .admin-content {
      padding: var(--space-phi-xl);
      max-width: 1440px;
      margin: 0 auto;
    }

    /* Page Header - Balanced */
    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-phi-xl);
    }
    .page-header-left {}
    .page-title {
      font-size: 28px;
      font-weight: var(--font-bold);
      color: var(--green-900);
      letter-spacing: -0.02em;
    }
    .page-subtitle {
      color: var(--gray-500);
      margin-top: var(--space-phi-xs);
      font-size: var(--text-sm);
    }
    .page-actions { display: flex; gap: var(--space-phi-sm); }

    /* Insight Cards - Fibonacci spacing */
    .insight-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-phi-lg);
      margin-bottom: var(--space-phi-xl);
    }
    @media (max-width: 1024px) {
      .insight-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      .insight-row { grid-template-columns: 1fr; }
    }

    .insight-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--space-phi-lg);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .insight-card:hover {
      border-color: var(--green-300);
      box-shadow: 0 4px 12px rgba(74, 124, 74, 0.08);
      transform: translateY(-1px);
    }
    .insight-card.active {
      border-color: var(--green-500);
      background: var(--green-50);
    }
    .insight-label {
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--gray-500);
      margin-bottom: var(--space-phi-sm);
    }
    .insight-value {
      font-size: 32px;
      font-weight: var(--font-bold);
      color: var(--green-800);
      line-height: 1;
    }
    .insight-card.warning .insight-value { color: var(--terra-600); }
    .insight-card.danger .insight-value { color: var(--error); }
    .insight-trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: var(--space-phi-sm);
      font-size: var(--text-xs);
      color: var(--gray-500);
    }
    .insight-trend.up { color: var(--success); }
    .insight-trend.down { color: var(--error); }

    /* Table Container */
    .table-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    /* Table Toolbar */
    .table-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-md) var(--space-phi-lg);
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
    }
    .filter-pills { display: flex; gap: 4px; }
    .filter-pill {
      padding: var(--space-phi-xs) var(--space-phi-md);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--gray-600);
      background: transparent;
      border: none;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .filter-pill:hover { background: var(--gray-100); color: var(--gray-800); }
    .filter-pill.active {
      background: var(--green-600);
      color: white;
    }
    .toolbar-actions { display: flex; gap: var(--space-phi-sm); }
    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: var(--space-phi-xs) var(--space-phi-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      color: var(--gray-600);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .toolbar-btn:hover {
      background: var(--bg-primary);
      border-color: var(--green-400);
      color: var(--green-700);
    }

    /* Data Table */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th {
      text-align: left;
      padding: var(--space-phi-md) var(--space-phi-lg);
      font-size: 11px;
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gray-500);
      background: var(--gray-50);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      user-select: none;
      transition: color 0.15s ease;
    }
    .data-table th:hover { color: var(--gray-700); }
    .data-table th.sorted { color: var(--green-700); }
    .data-table th.sorted::after {
      content: ' ↓';
      font-size: 10px;
    }
    .data-table th.sorted.desc::after { content: ' ↑'; }

    .data-table td {
      padding: var(--space-phi-md) var(--space-phi-lg);
      font-size: var(--text-sm);
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }
    .data-table tbody tr {
      cursor: pointer;
      transition: background 0.1s ease;
    }
    .data-table tbody tr:hover { background: var(--green-50); }
    .data-table tbody tr:last-child td { border-bottom: none; }

    /* Member Cell - Harmonious proportions */
    .member-cell { display: flex; align-items: center; gap: var(--space-phi-md); }
    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--green-200) 0%, var(--green-300) 100%);
      color: var(--green-800);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: var(--font-bold);
      flex-shrink: 0;
      letter-spacing: 0.02em;
    }
    .member-info {}
    .member-name {
      font-weight: var(--font-semibold);
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--space-phi-xs);
    }
    .member-email {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 2px;
    }
    .custom-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      font-size: 9px;
      font-weight: var(--font-bold);
      background: var(--terra-100);
      color: var(--terra-600);
      border-radius: var(--radius-full);
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: var(--font-semibold);
      border-radius: var(--radius-full);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .status-badge.active { background: var(--green-100); color: var(--green-800); }
    .status-badge.expiring { background: var(--terra-100); color: var(--terra-700); }
    .status-badge.expired { background: var(--error-light); color: var(--error); }
    .status-badge.pending { background: var(--gray-100); color: var(--gray-600); }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: var(--radius-full);
      background: currentColor;
    }

    /* Table Footer */
    .table-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-md) var(--space-phi-lg);
      background: var(--gray-50);
      font-size: var(--text-sm);
      color: var(--gray-500);
    }
    .pagination { display: flex; gap: 3px; }
    .page-btn {
      min-width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--gray-600);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .page-btn:hover:not(:disabled) {
      border-color: var(--green-400);
      color: var(--green-700);
    }
    .page-btn.active {
      background: var(--green-600);
      color: white;
      border-color: var(--green-600);
    }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Bulk Action Bar */
    .bulk-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-sm) var(--space-phi-lg);
      background: var(--green-100);
      border-bottom: 1px solid var(--green-200);
    }
    .bulk-bar-left {
      display: flex;
      align-items: center;
      gap: var(--space-phi-md);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--green-800);
    }
    .bulk-bar-actions {
      display: flex;
      gap: var(--space-phi-xs);
    }

    /* Checkbox styling */
    .row-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--green-600);
    }
    .data-table th input[type="checkbox"],
    .data-table td input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--green-600);
    }
    .data-table tbody tr.selected {
      background: var(--green-50);
    }

    /* Member name */
    .member-name {
      color: var(--gray-900);
      font-weight: var(--font-semibold);
    }

    /* Empty State - Welcoming */
    .empty-state {
      padding: var(--space-phi-2xl) var(--space-phi-xl);
      text-align: center;
    }
    .empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--space-phi-lg);
      background: linear-gradient(135deg, var(--green-100) 0%, var(--green-200) 100%);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--green-600);
    }
    .empty-title {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--gray-800);
      margin-bottom: var(--space-phi-sm);
    }
    .empty-text {
      color: var(--gray-500);
      max-width: 360px;
      margin: 0 auto var(--space-phi-lg);
      line-height: 1.6;
    }
    .empty-actions { display: flex; gap: var(--space-phi-sm); justify-content: center; }

    /* Modal Backdrop & Base */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(2px);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .modal-backdrop.active { opacity: 1; visibility: visible; }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -48%);
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      width: 480px;
      max-width: calc(100% - var(--space-phi-xl));
      max-height: calc(100vh - var(--space-phi-xl));
      overflow: hidden;
      z-index: 101;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%); }
    .modal.wide { width: 640px; }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-lg) var(--space-phi-xl);
      border-bottom: 1px solid var(--border-color);
    }
    .modal-title { font-size: var(--text-lg); font-weight: var(--font-semibold); }
    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-400);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .modal-close:hover { background: var(--gray-100); color: var(--gray-600); }
    .modal-body {
      padding: var(--space-phi-xl);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-phi-sm);
      padding: var(--space-phi-lg) var(--space-phi-xl);
      border-top: 1px solid var(--border-color);
      background: var(--gray-50);
    }

    /* Slide Panel */
    .slide-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 540px;
      max-width: 100%;
      background: var(--bg-primary);
      box-shadow: -8px 0 30px rgba(0,0,0,0.12);
      z-index: 101;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }
    .slide-panel.active { transform: translateX(0); }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-lg) var(--space-phi-xl);
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-primary);
    }
    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-phi-xl);
    }
    .panel-footer {
      padding: var(--space-phi-lg) var(--space-phi-xl);
      border-top: 1px solid var(--border-color);
      background: var(--gray-50);
    }

    /* Member Detail */
    .detail-hero {
      display: flex;
      align-items: center;
      gap: var(--space-phi-lg);
      margin-bottom: var(--space-phi-xl);
      padding-bottom: var(--space-phi-xl);
      border-bottom: 1px solid var(--border-color);
    }
    .detail-avatar {
      width: 72px;
      height: 72px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--green-200) 0%, var(--green-400) 100%);
      color: var(--green-900);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: var(--font-bold);
      flex-shrink: 0;
    }
    .detail-meta {}
    .detail-name {
      font-size: 22px;
      font-weight: var(--font-bold);
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    .detail-email {
      font-size: var(--text-sm);
      color: var(--gray-500);
      margin-bottom: var(--space-phi-sm);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: var(--space-phi-xl);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: var(--space-phi-lg);
    }
    .tab-btn {
      padding: var(--space-phi-sm) 0;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--gray-500);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.15s ease;
    }
    .tab-btn:hover { color: var(--gray-700); }
    .tab-btn.active { color: var(--green-700); }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--green-600);
      border-radius: 1px;
    }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    /* Detail Section */
    .detail-section { margin-bottom: var(--space-phi-xl); }
    .section-title {
      font-size: 11px;
      font-weight: var(--font-bold);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--gray-400);
      margin-bottom: var(--space-phi-md);
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-phi-lg);
    }
    .detail-item {}
    .detail-label {
      font-size: 12px;
      color: var(--gray-400);
      margin-bottom: 3px;
    }
    .detail-value {
      font-size: var(--text-sm);
      color: var(--gray-800);
      font-weight: var(--font-medium);
    }

    /* Custom Fields in Panel */
    .custom-fields-grid {
      display: grid;
      gap: var(--space-phi-sm);
    }
    .custom-field-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-phi-sm) var(--space-phi-md);
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }
    .custom-field-key {
      font-size: 12px;
      color: var(--gray-500);
      font-weight: var(--font-medium);
    }
    .custom-field-val {
      font-size: var(--text-sm);
      color: var(--gray-800);
    }

    /* Timeline */
    .timeline { margin-left: var(--space-phi-sm); }
    .timeline-item {
      position: relative;
      padding-left: var(--space-phi-xl);
      padding-bottom: var(--space-phi-lg);
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 6px;
      width: 10px;
      height: 10px;
      background: var(--green-500);
      border: 2px solid var(--bg-primary);
      border-radius: var(--radius-full);
    }
    .timeline-item::after {
      content: '';
      position: absolute;
      left: 4px;
      top: 20px;
      bottom: 0;
      width: 2px;
      background: var(--gray-200);
    }
    .timeline-item:last-child::after { display: none; }
    .timeline-date { font-size: 11px; color: var(--gray-400); margin-bottom: 2px; }
    .timeline-text { font-size: var(--text-sm); color: var(--gray-700); }

    /* Notes */
    .notes-list {}
    .note-item {
      padding: var(--space-phi-md);
      background: var(--green-50);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-phi-sm);
    }
    .note-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-phi-xs);
    }
    .note-author { font-size: 12px; font-weight: var(--font-semibold); color: var(--gray-700); }
    .note-date { font-size: 11px; color: var(--gray-400); }
    .note-text { font-size: var(--text-sm); color: var(--gray-600); line-height: 1.5; }
    .note-form { margin-top: var(--space-phi-md); }
    .note-input {
      width: 100%;
      padding: var(--space-phi-sm);
      font-size: var(--text-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      resize: none;
      transition: border-color 0.15s ease;
    }
    .note-input:focus {
      border-color: var(--green-400);
      outline: none;
    }

    /* Import Flow */
    .import-dropzone {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-xl);
      padding: var(--space-phi-2xl) var(--space-phi-xl);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .import-dropzone:hover,
    .import-dropzone.dragover {
      border-color: var(--green-500);
      background: var(--green-50);
    }
    .dropzone-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto var(--space-phi-md);
      color: var(--gray-400);
    }
    .dropzone-text { font-size: var(--text-sm); color: var(--gray-500); }
    .dropzone-text strong { color: var(--green-600); }

    .template-download {
      display: inline-flex;
      align-items: center;
      gap: var(--space-phi-xs);
      margin-top: var(--space-phi-lg);
      padding: var(--space-phi-sm) var(--space-phi-md);
      font-size: var(--text-sm);
      color: var(--green-700);
      background: var(--green-50);
      border: 1px solid var(--green-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .template-download:hover {
      background: var(--green-100);
      border-color: var(--green-300);
    }

    .import-preview { margin-top: var(--space-phi-lg); }
    .preview-info {
      display: flex;
      align-items: center;
      gap: var(--space-phi-sm);
      padding: var(--space-phi-sm) var(--space-phi-md);
      background: var(--green-50);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-phi-md);
    }
    .preview-info svg { color: var(--green-600); }
    .preview-info span { font-size: var(--text-sm); color: var(--green-800); }

    .preview-table {
      width: 100%;
      font-size: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .preview-table th,
    .preview-table td {
      padding: var(--space-phi-xs) var(--space-phi-sm);
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    .preview-table th {
      background: var(--gray-50);
      font-weight: var(--font-medium);
      color: var(--gray-500);
    }
    .preview-table tbody tr:last-child td { border-bottom: none; }

    .mapping-section { margin-top: var(--space-phi-lg); }
    .mapping-title {
      font-size: 12px;
      font-weight: var(--font-semibold);
      color: var(--gray-600);
      margin-bottom: var(--space-phi-sm);
    }
    .mapping-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-phi-md);
      align-items: center;
      padding: var(--space-phi-sm) 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .mapping-row:last-child { border-bottom: none; }
    .mapping-col { font-size: var(--text-sm); font-weight: var(--font-medium); }
    .mapping-arrow { color: var(--gray-300); }
    .mapping-select {
      padding: var(--space-phi-xs) var(--space-phi-sm);
      font-size: var(--text-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
    }

    /* Duplicate Warning */
    .dup-banner {
      display: flex;
      gap: var(--space-phi-md);
      padding: var(--space-phi-md);
      background: var(--terra-50);
      border: 1px solid var(--terra-200);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-phi-lg);
    }
    .dup-banner svg { color: var(--terra-500); flex-shrink: 0; margin-top: 2px; }
    .dup-banner-text { font-size: var(--text-sm); color: var(--terra-700); }
    .dup-banner-actions {
      display: flex;
      gap: var(--space-phi-sm);
      margin-top: var(--space-phi-sm);
    }

    /* Command Palette */
    .cmd-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.15s ease;
    }
    .cmd-backdrop.active { opacity: 1; visibility: visible; }

    .cmd-dialog {
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%) scale(0.98);
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      width: 560px;
      max-width: calc(100% - var(--space-phi-xl));
      z-index: 201;
      opacity: 0;
      visibility: hidden;
      transition: all 0.15s ease;
      overflow: hidden;
    }
    .cmd-dialog.active { opacity: 1; visibility: visible; transform: translateX(-50%) scale(1); }

    .cmd-input {
      width: 100%;
      padding: var(--space-phi-lg);
      font-size: var(--text-lg);
      border: none;
      border-bottom: 1px solid var(--border-color);
    }
    .cmd-input:focus { outline: none; }
    .cmd-input::placeholder { color: var(--gray-400); }

    .cmd-results { max-height: 360px; overflow-y: auto; }
    .cmd-section {
      padding: var(--space-phi-sm) var(--space-phi-lg);
      font-size: 11px;
      font-weight: var(--font-bold);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--gray-400);
      background: var(--gray-50);
    }
    .cmd-item {
      display: flex;
      align-items: center;
      gap: var(--space-phi-md);
      padding: var(--space-phi-sm) var(--space-phi-lg);
      cursor: pointer;
      transition: background 0.1s ease;
    }
    .cmd-item:hover { background: var(--green-50); }
    .cmd-item-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--green-100);
      color: var(--green-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: var(--font-bold);
    }
    .cmd-item-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-500);
    }
    .cmd-item-text {}
    .cmd-item-title { font-size: var(--text-sm); font-weight: var(--font-medium); }
    .cmd-item-sub { font-size: 12px; color: var(--gray-400); }
    .cmd-empty {
      padding: var(--space-phi-xl);
      text-align: center;
      color: var(--gray-400);
    }

    /* Toast Notifications */
    .toast-stack {
      position: fixed;
      bottom: var(--space-phi-lg);
      right: var(--space-phi-lg);
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: var(--space-phi-sm);
    }
    .toast {
      display: flex;
      align-items: center;
      gap: var(--space-phi-sm);
      padding: var(--space-phi-md) var(--space-phi-lg);
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      font-size: var(--text-sm);
      animation: toastIn 0.3s ease;
    }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--error); }
    @keyframes toastIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Quick Action Button */
    .quick-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--gray-400);
      transition: all 0.15s ease;
    }
    .quick-action-btn:hover {
      background: var(--gray-100);
      color: var(--gray-600);
    }
    .data-table tbody tr:hover .quick-action-btn {
      color: var(--gray-500);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-content { padding: var(--space-phi-lg); }
      .page-header { flex-direction: column; gap: var(--space-phi-md); }
      .page-actions { width: 100%; }
      .page-actions .btn { flex: 1; }
      .slide-panel { width: 100%; }
      .search-input { width: 200px; }
      .search-input:focus { width: 200px; }
      .table-toolbar { flex-direction: column; gap: var(--space-phi-sm); align-items: stretch; }
      .filter-pills { overflow-x: auto; padding-bottom: 4px; }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <a href="/admin/" style="color: white; font-size: var(--text-xl); font-weight: var(--font-bold);">VillageMembers</a>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
          Dashboard
        </a>
        <a href="/admin/members.html" class="sidebar-link active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Members
        </a>
        <a href="/admin/tiers.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
          Tiers
        </a>
        <div class="sidebar-section">Credentials & CEU</div>
        <a href="/admin/credentials.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
          Credentials
        </a>
        <a href="/admin/ceu-credits.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Review Credits
        </a>
        <div class="sidebar-section">Settings</div>
        <a href="/admin/settings.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="admin-main">
      <header class="admin-header">
        <div class="search-container">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input type="text" class="search-input" id="searchInput" placeholder="Search members...">
          <span class="search-shortcut">⌘K</span>
        </div>
        <div class="header-actions">
          <span id="userName" class="text-sm" style="color: var(--gray-500);"></span>
          <button onclick="logout()" class="btn btn-ghost btn-sm">Logout</button>
        </div>
      </header>

      <div class="admin-content">
        <!-- Page Header -->
        <div class="page-header">
          <div class="page-header-left">
            <h1 class="page-title">Members</h1>
            <p class="page-subtitle" id="memberCount">Loading your community...</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" id="exportBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export
            </button>
            <button class="btn btn-secondary" id="importBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Import
            </button>
            <button class="btn btn-primary" id="addBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Member
            </button>
          </div>
        </div>

        <!-- Insight Cards -->
        <div class="insight-row">
          <div class="insight-card" data-filter="all" id="cardAll">
            <div class="insight-label">Total Members</div>
            <div class="insight-value" id="insightTotal">-</div>
            <div class="insight-trend up" id="insightTrend"></div>
          </div>
          <div class="insight-card" data-filter="active" id="cardActive">
            <div class="insight-label">Active</div>
            <div class="insight-value" id="insightActive">-</div>
          </div>
          <div class="insight-card warning" data-filter="expiring" id="cardExpiring">
            <div class="insight-label">Expiring Soon</div>
            <div class="insight-value" id="insightExpiring">-</div>
          </div>
          <div class="insight-card danger" data-filter="expired" id="cardExpired">
            <div class="insight-label">Expired</div>
            <div class="insight-value" id="insightExpired">-</div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-container">
          <div class="table-toolbar">
            <div class="filter-pills">
              <button class="filter-pill active" data-filter="all">All</button>
              <button class="filter-pill" data-filter="active">Active</button>
              <button class="filter-pill" data-filter="expiring">Expiring</button>
              <button class="filter-pill" data-filter="expired">Expired</button>
              <button class="filter-pill" data-filter="pending">Pending</button>
            </div>
          </div>

          <!-- Bulk Action Bar (hidden by default) -->
          <div class="bulk-bar" id="bulkBar" style="display:none">
            <div class="bulk-bar-left">
              <span id="bulkCount">0</span> selected
              <button class="btn btn-ghost btn-sm" onclick="clearSelection()">Clear</button>
            </div>
            <div class="bulk-bar-actions">
              <button class="btn btn-secondary btn-sm" onclick="bulkExport()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export
              </button>
              <button class="btn btn-secondary btn-sm" onclick="bulkChangeStatus('active')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                Mark Active
              </button>
              <button class="btn btn-secondary btn-sm" onclick="bulkChangeStatus('expired')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                Mark Expired
              </button>
              <button class="btn btn-ghost btn-sm" style="color:var(--error)" onclick="bulkDelete()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                Delete
              </button>
            </div>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th style="width:40px;padding-left:var(--space-phi-md)">
                  <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                </th>
                <th data-sort="name" class="sorted">Member</th>
                <th data-sort="status">Status</th>
                <th data-sort="tier">Tier</th>
                <th data-sort="phone">Phone</th>
                <th data-sort="expires">Expires</th>
                <th data-sort="joined">Joined</th>
                <th style="width:50px;"></th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="8" style="text-align:center;padding:var(--space-phi-xl);color:var(--gray-400)">Loading...</td></tr>
            </tbody>
          </table>

          <div class="table-footer">
            <span id="tableInfo">-</span>
            <div class="pagination" id="pagination"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile Nav -->
    <nav class="bottom-nav">
      <a href="/admin/" class="bottom-nav-link">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
        Home
      </a>
      <a href="/admin/members.html" class="bottom-nav-link active">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Members
      </a>
      <a href="/admin/settings.html" class="bottom-nav-link">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </a>
    </nav>
  </div>

  <!-- Command Palette -->
  <div class="cmd-backdrop" id="cmdBackdrop"></div>
  <div class="cmd-dialog" id="cmdDialog">
    <input type="text" class="cmd-input" id="cmdInput" placeholder="Search members, actions...">
    <div class="cmd-results" id="cmdResults"></div>
  </div>

  <!-- Add Member Modal -->
  <div class="modal-backdrop" id="addBackdrop"></div>
  <div class="modal" id="addModal">
    <div class="modal-header">
      <h3 class="modal-title">Add Member</h3>
      <button class="modal-close" onclick="closeAdd()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="dup-banner" id="dupBanner" style="display:none">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <div>
          <div class="dup-banner-text" id="dupText"></div>
          <div class="dup-banner-actions">
            <button class="btn btn-sm btn-secondary" onclick="viewDuplicate()">View Existing</button>
            <button class="btn btn-sm btn-ghost" onclick="ignoreDuplicate()">Add Anyway</button>
          </div>
        </div>
      </div>
      <form id="addForm" onsubmit="submitAdd(event)">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-phi-md);margin-bottom:var(--space-phi-md)">
          <div class="form-group" style="margin:0">
            <label class="label">First Name *</label>
            <input type="text" class="input" name="first_name" required>
          </div>
          <div class="form-group" style="margin:0">
            <label class="label">Last Name *</label>
            <input type="text" class="input" name="last_name" required>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Email *</label>
          <input type="email" class="input" name="email" id="addEmail" required>
        </div>
        <div class="form-group">
          <label class="label">Phone</label>
          <input type="tel" class="input" name="phone" id="addPhone" placeholder="(555) 123-4567">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-phi-md);margin-bottom:var(--space-phi-md)">
          <div class="form-group" style="margin:0">
            <label class="label">Tier</label>
            <select class="input" name="tier_id" id="addTier">
              <option value="">Select tier...</option>
            </select>
          </div>
          <div class="form-group" style="margin:0">
            <label class="label">Status</label>
            <select class="input" name="status">
              <option value="active">Active</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="label">Expiration Date</label>
          <input type="date" class="input" name="expires_at">
        </div>
        <div id="customFieldsForm"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeAdd()">Cancel</button>
      <button type="submit" form="addForm" class="btn btn-primary">Add Member</button>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal-backdrop" id="importBackdrop"></div>
  <div class="modal wide" id="importModal">
    <div class="modal-header">
      <h3 class="modal-title">Import Members</h3>
      <button class="modal-close" onclick="closeImport()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="import-dropzone" id="dropzone">
        <svg class="dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
        <p class="dropzone-text"><strong>Click to upload</strong> or drag and drop</p>
        <p class="dropzone-text" style="margin-top:4px;font-size:12px">CSV files only</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
      </div>
      <button class="template-download" onclick="downloadTemplate()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Download import template
      </button>
      <div id="importPreview" class="import-preview" style="display:none">
        <div class="preview-info">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <span id="previewCount">-</span>
        </div>
        <table class="preview-table">
          <thead id="previewHead"></thead>
          <tbody id="previewBody"></tbody>
        </table>
        <div class="mapping-section">
          <div class="mapping-title">Map columns to fields</div>
          <div id="mappingRows"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeImport()">Cancel</button>
      <button type="button" class="btn btn-primary" id="importConfirm" disabled onclick="doImport()">Import Members</button>
    </div>
  </div>

  <!-- Member Detail Panel -->
  <div class="modal-backdrop" id="panelBackdrop"></div>
  <div class="slide-panel" id="memberPanel">
    <div class="panel-header">
      <h3 class="modal-title">Member Details</h3>
      <button class="modal-close" onclick="closePanel()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="panel-body">
      <div class="detail-hero">
        <div class="detail-avatar" id="panelAvatar">?</div>
        <div class="detail-meta">
          <div class="detail-name" id="panelName">-</div>
          <div class="detail-email" id="panelEmail">-</div>
          <span class="status-badge active" id="panelStatus"><span class="status-dot"></span> Active</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="profile">Profile</button>
        <button class="tab-btn" data-tab="activity">Activity</button>
        <button class="tab-btn" data-tab="notes">Notes</button>
      </div>

      <div class="tab-pane active" id="tab-profile">
        <div class="detail-section">
          <div class="section-title">Contact</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value" id="pEmail">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value" id="pPhone">-</div>
            </div>
          </div>
        </div>
        <div class="detail-section">
          <div class="section-title">Membership</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Tier</div>
              <div class="detail-value" id="pTier">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value" id="pStatus">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Member Since</div>
              <div class="detail-value" id="pJoined">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Expires</div>
              <div class="detail-value" id="pExpires">-</div>
            </div>
          </div>
        </div>
        <div class="detail-section" id="customFieldsSection" style="display:none">
          <div class="section-title">Additional Information</div>
          <div class="custom-fields-grid" id="customFieldsGrid"></div>
        </div>
      </div>

      <div class="tab-pane" id="tab-activity">
        <div class="timeline" id="timeline">
          <div class="timeline-item">
            <div class="timeline-date">-</div>
            <div class="timeline-text">No activity recorded</div>
          </div>
        </div>
      </div>

      <div class="tab-pane" id="tab-notes">
        <div class="notes-list" id="notesList">
          <p style="color:var(--gray-400);font-size:var(--text-sm)">No notes yet</p>
        </div>
        <div class="note-form">
          <textarea class="note-input" id="noteInput" rows="3" placeholder="Add a note about this member..."></textarea>
          <button class="btn btn-primary btn-sm" style="margin-top:var(--space-phi-sm)" onclick="addNote()">Add Note</button>
        </div>
      </div>
    </div>
    <div class="panel-footer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <button class="btn btn-ghost btn-sm" style="color:var(--error)" onclick="deleteMember()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Delete
        </button>
        <a id="editLink" class="btn btn-secondary btn-sm">Edit Profile</a>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script src="/js/ui-utils.js"></script>
  <script>
    const state = {
      members: [],
      filtered: [],
      tiers: [],
      filter: 'all',
      sort: 'name',
      sortDir: 'asc',
      search: '',
      page: 1,
      perPage: 20,
      selected: null,
      selectedIds: [],  // For bulk selection
      importData: null,
      importMap: {},
      dup: null,
      ignoreDup: false
    };

    const $ = id => document.getElementById(id);

    // Initialize
    async function init() {
      if (!await checkAuth()) return;

      // Show skeleton loading while fetching data
      $('tableBody').innerHTML = skeleton.tableRows(8, 7);
      $('insightTotal').innerHTML = '<span class="skeleton" style="display:inline-block;width:32px;height:24px;"></span>';
      $('insightActive').innerHTML = '<span class="skeleton" style="display:inline-block;width:32px;height:24px;"></span>';
      $('insightExpiring').innerHTML = '<span class="skeleton" style="display:inline-block;width:32px;height:24px;"></span>';
      $('insightExpired').innerHTML = '<span class="skeleton" style="display:inline-block;width:32px;height:24px;"></span>';

      const [members, tiers] = await Promise.all([fetchMembers(), fetchTiers()]);
      state.members = members;
      state.tiers = tiers;
      updateInsights();
      applyFilter();
      setupEvents();
    }

    async function checkAuth() {
      try {
        const r = await fetch('/auth/me?type=user', { credentials: 'include' });
        if (!r.ok) { location.href = '/login'; return false; }
        const d = await r.json();
        if (d.type !== 'user') { location.href = '/login'; return false; }
        $('userName').textContent = d.name || d.email || '';
        return true;
      } catch { location.href = '/login'; return false; }
    }

    async function logout() {
      await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      location.href = '/login';
    }

    async function fetchMembers() {
      try {
        const r = await fetch('/api/v1/members?limit=1000', { credentials: 'include' });
        const d = await r.json();
        return d.members || [];
      } catch { return []; }
    }

    async function fetchTiers() {
      try {
        const r = await fetch('/api/v1/tiers', { credentials: 'include' });
        const d = await r.json();
        return d.tiers || [];
      } catch { return []; }
    }

    // Helpers
    const initials = (f, l) => `${(f||'')[0]||''}${(l||'')[0]||''}`.toUpperCase() || '?';
    const fmtDate = d => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-';
    const fmtPhone = p => p || '-';

    function getStatus(status, expiresAt) {
      if (status === 'expired') return { cls: 'expired', label: 'Expired' };
      if (status === 'pending') return { cls: 'pending', label: 'Pending' };
      if (expiresAt) {
        const days = Math.ceil((new Date(expiresAt) - new Date()) / 86400000);
        if (days <= 0) return { cls: 'expired', label: 'Expired' };
        if (days <= 30) return { cls: 'expiring', label: `${days}d left` };
      }
      return { cls: 'active', label: 'Active' };
    }

    function showToast(msg, type = 'success') {
      if (type === 'success') toast.success(msg);
      else toast.error(msg);
    }

    // Insights
    function updateInsights() {
      const now = new Date();
      const total = state.members.length;
      const active = state.members.filter(m => m.status === 'active').length;
      const expired = state.members.filter(m => m.status === 'expired').length;
      const expiring = state.members.filter(m => {
        if (!m.expires_at || m.status !== 'active') return false;
        const d = Math.ceil((new Date(m.expires_at) - now) / 86400000);
        return d > 0 && d <= 30;
      }).length;

      $('insightTotal').textContent = total;
      $('insightActive').textContent = active;
      $('insightExpiring').textContent = expiring;
      $('insightExpired').textContent = expired;
      $('memberCount').textContent = `${total} member${total !== 1 ? 's' : ''} in your community`;
    }

    // Filter & Sort
    function applyFilter() {
      let arr = [...state.members];
      const now = new Date();

      if (state.filter === 'active') arr = arr.filter(m => m.status === 'active');
      else if (state.filter === 'expired') arr = arr.filter(m => m.status === 'expired');
      else if (state.filter === 'pending') arr = arr.filter(m => m.status === 'pending');
      else if (state.filter === 'expiring') {
        arr = arr.filter(m => {
          if (!m.expires_at || m.status !== 'active') return false;
          const d = Math.ceil((new Date(m.expires_at) - now) / 86400000);
          return d > 0 && d <= 30;
        });
      }

      if (state.search) {
        const q = state.search.toLowerCase();
        arr = arr.filter(m =>
          [m.first_name, m.last_name, m.email, m.phone, m.tier_name]
            .filter(Boolean).join(' ').toLowerCase().includes(q)
        );
      }

      arr.sort((a, b) => {
        let av, bv;
        if (state.sort === 'name') {
          av = `${a.first_name||''} ${a.last_name||''}`;
          bv = `${b.first_name||''} ${b.last_name||''}`;
        } else if (state.sort === 'tier') {
          av = a.tier_name || '';
          bv = b.tier_name || '';
        } else {
          av = a[state.sort] || '';
          bv = b[state.sort] || '';
        }
        if (typeof av === 'string') { av = av.toLowerCase(); bv = bv.toLowerCase(); }
        return state.sortDir === 'asc' ? (av < bv ? -1 : av > bv ? 1 : 0) : (av > bv ? -1 : av < bv ? 1 : 0);
      });

      state.filtered = arr;
      state.page = 1;
      render();
    }

    function render() {
      const start = (state.page - 1) * state.perPage;
      const end = start + state.perPage;
      const slice = state.filtered.slice(start, end);

      if (slice.length === 0) {
        $('tableBody').innerHTML = `
          <tr><td colspan="8">
            <div class="empty-state">
              <div class="empty-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              </div>
              <h3 class="empty-title">${state.search ? 'No members found' : 'No members yet'}</h3>
              <p class="empty-text">${state.search ? 'Try adjusting your search or filters' : 'Start building your community by adding your first member or importing from a spreadsheet.'}</p>
              <div class="empty-actions">
                ${!state.search ? `
                  <button class="btn btn-primary" onclick="openAdd()">Add Member</button>
                  <button class="btn btn-secondary" onclick="openImport()">Import CSV</button>
                ` : ''}
              </div>
            </div>
          </td></tr>
        `;
      } else {
        $('tableBody').innerHTML = slice.map(m => {
          const status = getStatus(m.status, m.expires_at);
          const hasCustom = m.custom_fields && Object.keys(m.custom_fields).length > 0;
          const isSelected = state.selectedIds.includes(m.id);
          return `
            <tr class="${isSelected ? 'selected' : ''}" onclick="goToMember(event, '${m.id}')" style="cursor:pointer">
              <td style="padding-left:var(--space-phi-md)" onclick="event.stopPropagation()">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${m.id}', this.checked)">
              </td>
              <td>
                <div class="member-cell">
                  <div class="member-avatar">${initials(m.first_name, m.last_name)}</div>
                  <div class="member-info">
                    <span class="member-name">
                      ${m.first_name||''} ${m.last_name||''}
                      ${hasCustom ? `<span class="custom-indicator" title="Has custom fields">+${Object.keys(m.custom_fields).length}</span>` : ''}
                    </span>
                    <div class="member-email">${m.email||''}</div>
                  </div>
                </div>
              </td>
              <td><span class="status-badge ${status.cls}"><span class="status-dot"></span>${status.label}</span></td>
              <td>${m.tier_name || '<span style="color:var(--gray-400)">-</span>'}</td>
              <td>${fmtPhone(m.phone)}</td>
              <td>${fmtDate(m.expires_at)}</td>
              <td>${fmtDate(m.created_at)}</td>
              <td onclick="event.stopPropagation()">
                <button class="quick-action-btn" onclick="showQuickActions(event, '${m.id}')" title="Actions">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                  </svg>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Update select all checkbox
      const selectAllEl = $('selectAll');
      if (selectAllEl) {
        const pageIds = slice.map(m => m.id);
        const allSelected = pageIds.length > 0 && pageIds.every(id => state.selectedIds.includes(id));
        selectAllEl.checked = allSelected;
      }

      const total = state.filtered.length;
      $('tableInfo').textContent = total > 0 ? `${start + 1}-${Math.min(end, total)} of ${total}` : 'No results';
      renderPagination(total);

      // Update insight card active states
      document.querySelectorAll('.insight-card').forEach(c => {
        c.classList.toggle('active', c.dataset.filter === state.filter);
      });
    }

    function renderPagination(total) {
      const pages = Math.ceil(total / state.perPage);
      if (pages <= 1) { $('pagination').innerHTML = ''; return; }

      let h = `<button class="page-btn" ${state.page === 1 ? 'disabled' : ''} onclick="goPage(${state.page - 1})">←</button>`;
      for (let i = 1; i <= pages; i++) {
        if (i === 1 || i === pages || Math.abs(i - state.page) <= 1) {
          h += `<button class="page-btn ${i === state.page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
        } else if (Math.abs(i - state.page) === 2) {
          h += `<span style="padding:0 4px;color:var(--gray-400)">...</span>`;
        }
      }
      h += `<button class="page-btn" ${state.page === pages ? 'disabled' : ''} onclick="goPage(${state.page + 1})">→</button>`;
      $('pagination').innerHTML = h;
    }

    function goPage(p) { state.page = p; render(); }

    function setFilter(f) {
      state.filter = f;
      document.querySelectorAll('.filter-pill').forEach(p => p.classList.toggle('active', p.dataset.filter === f));
      applyFilter();
    }

    function setSort(col) {
      if (state.sort === col) {
        state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        state.sort = col;
        state.sortDir = 'asc';
      }
      document.querySelectorAll('.data-table th').forEach(th => {
        th.classList.remove('sorted', 'desc');
        if (th.dataset.sort === col) {
          th.classList.add('sorted');
          if (state.sortDir === 'desc') th.classList.add('desc');
        }
      });
      applyFilter();
    }

    // Command Palette
    function openCmd() {
      $('cmdBackdrop').classList.add('active');
      $('cmdDialog').classList.add('active');
      $('cmdInput').value = '';
      $('cmdInput').focus();
      renderCmd('');
    }

    function closeCmd() {
      $('cmdBackdrop').classList.remove('active');
      $('cmdDialog').classList.remove('active');
    }

    function renderCmd(q) {
      const lq = q.toLowerCase();
      const members = state.members.filter(m =>
        `${m.first_name||''} ${m.last_name||''} ${m.email||''}`.toLowerCase().includes(lq)
      ).slice(0, 5);

      const actions = [
        { t: 'Add new member', a: 'add', icon: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' },
        { t: 'Export to CSV', a: 'export', icon: '<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>' },
        { t: 'Import from CSV', a: 'import', icon: '<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>' }
      ].filter(x => x.t.toLowerCase().includes(lq));

      let h = '';
      if (members.length) {
        h += '<div class="cmd-section">Members</div>';
        members.forEach(m => {
          h += `<div class="cmd-item" onclick="location.href='/admin/member.html?id=${m.id}'">
            <div class="cmd-item-avatar">${initials(m.first_name, m.last_name)}</div>
            <div class="cmd-item-text">
              <div class="cmd-item-title">${m.first_name||''} ${m.last_name||''}</div>
              <div class="cmd-item-sub">${m.email||''}</div>
            </div>
          </div>`;
        });
      }
      if (actions.length) {
        h += '<div class="cmd-section">Actions</div>';
        actions.forEach(a => {
          h += `<div class="cmd-item" onclick="doAction('${a.a}');closeCmd()">
            <div class="cmd-item-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${a.icon}</svg></div>
            <div class="cmd-item-text"><div class="cmd-item-title">${a.t}</div></div>
          </div>`;
        });
      }
      if (!h) h = '<div class="cmd-empty">No results found</div>';
      $('cmdResults').innerHTML = h;
    }

    function doAction(a) {
      if (a === 'add') openAdd();
      else if (a === 'export') exportCSV();
      else if (a === 'import') openImport();
    }

    // Add Modal
    function openAdd() {
      $('addBackdrop').classList.add('active');
      $('addModal').classList.add('active');
      $('addForm').reset();
      $('dupBanner').style.display = 'none';
      state.ignoreDup = false;
      state.dup = null;
      $('addTier').innerHTML = '<option value="">Select tier...</option>' +
        state.tiers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function closeAdd() {
      $('addBackdrop').classList.remove('active');
      $('addModal').classList.remove('active');
    }

    function checkDup() {
      if (state.ignoreDup) return;
      const email = $('addEmail').value.toLowerCase().trim();
      const phone = $('addPhone').value.replace(/\D/g, '');

      for (const m of state.members) {
        if (email && (m.email||'').toLowerCase() === email) {
          state.dup = m;
          $('dupText').textContent = `A member with this email already exists: ${m.first_name} ${m.last_name}`;
          $('dupBanner').style.display = 'flex';
          return;
        }
        if (phone.length >= 10 && (m.phone||'').replace(/\D/g, '') === phone) {
          state.dup = m;
          $('dupText').textContent = `A member with this phone already exists: ${m.first_name} ${m.last_name}`;
          $('dupBanner').style.display = 'flex';
          return;
        }
      }
      state.dup = null;
      $('dupBanner').style.display = 'none';
    }

    function viewDuplicate() { if (state.dup) { closeAdd(); openPanel(state.dup.id); } }
    function ignoreDuplicate() { state.ignoreDup = true; $('dupBanner').style.display = 'none'; }

    async function submitAdd(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd);
      Object.keys(data).forEach(k => { if (!data[k]) delete data[k]; });

      try {
        const r = await fetch('/api/v1/members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if (!r.ok) { const e = await r.json(); throw new Error(e.error); }
        showToast('Member added successfully');
        closeAdd();
        state.members = await fetchMembers();
        updateInsights();
        applyFilter();
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Import Modal
    function openImport() {
      $('importBackdrop').classList.add('active');
      $('importModal').classList.add('active');
      resetImport();
    }

    function closeImport() {
      $('importBackdrop').classList.remove('active');
      $('importModal').classList.remove('active');
    }

    function resetImport() {
      state.importData = null;
      state.importMap = {};
      $('dropzone').style.display = 'block';
      $('importPreview').style.display = 'none';
      $('importConfirm').disabled = true;
      $('fileInput').value = '';
    }

    function downloadTemplate() {
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Status', 'Expires'];
      const example = ['Jane', 'Smith', 'jane@example.com', '555-987-6543', 'active', '2026-12-31'];
      const csv = [headers.join(','), example.join(',')].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = 'member-import-template.csv';
      a.click();
      showToast('Template downloaded');
    }

    function parseCSV(txt) {
      const lines = txt.split('\n').filter(l => l.trim());
      if (lines.length < 2) return { h: [], r: [] };
      const parse = line => {
        const a = []; let c = '', q = false;
        for (let i = 0; i < line.length; i++) {
          if (line[i] === '"') q = !q;
          else if (line[i] === ',' && !q) { a.push(c.trim()); c = ''; }
          else c += line[i];
        }
        a.push(c.trim());
        return a;
      };
      return { h: parse(lines[0]), r: lines.slice(1).map(parse) };
    }

    function handleFile(f) {
      if (!f || !f.name.endsWith('.csv')) { showToast('Please select a CSV file', 'error'); return; }
      const reader = new FileReader();
      reader.onload = e => {
        const { h, r } = parseCSV(e.target.result);
        if (!h.length || !r.length) { showToast('Invalid CSV file', 'error'); return; }
        state.importData = { h, r };
        showImportPreview();
      };
      reader.readAsText(f);
    }

    function showImportPreview() {
      const { h, r } = state.importData;
      $('dropzone').style.display = 'none';
      $('importPreview').style.display = 'block';
      $('previewCount').textContent = `${r.length} row${r.length !== 1 ? 's' : ''} ready to import`;
      $('previewHead').innerHTML = `<tr>${h.map(x => `<th>${x}</th>`).join('')}</tr>`;
      $('previewBody').innerHTML = r.slice(0, 3).map(row => `<tr>${row.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');

      // Standard member fields
      const standardFields = [
        { k: 'first_name', l: 'First Name' },
        { k: 'last_name', l: 'Last Name' },
        { k: 'email', l: 'Email' },
        { k: 'phone', l: 'Phone' },
        { k: 'status', l: 'Status' },
        { k: 'expires_at', l: 'Expires' }
      ];

      // Auto-map columns to fields
      h.forEach((col, i) => {
        const cl = col.toLowerCase().replace(/[^a-z]/g, '');

        // First try standard fields
        let matched = false;
        for (const f of standardFields) {
          const fl = f.l.toLowerCase().replace(/[^a-z]/g, '');
          if (cl.includes(fl) || fl.includes(cl) || cl === f.k.replace(/_/g, '')) {
            state.importMap[i] = f.k;
            matched = true;
            break;
          }
        }

        // If no standard match, map as custom field (using original column name)
        if (!matched && col.trim()) {
          state.importMap[i] = `custom:${col.trim()}`;
        }
      });

      $('mappingRows').innerHTML = h.map((col, i) => {
        const currentVal = state.importMap[i] || '';
        const isCustom = currentVal.startsWith('custom:');

        return `
        <div class="mapping-row">
          <span class="mapping-col">${col}</span>
          <span class="mapping-arrow">→</span>
          <select class="mapping-select" onchange="updateMapping(${i}, this.value)">
            <option value="">Skip this column</option>
            <optgroup label="Standard Fields">
              ${standardFields.map(f => `<option value="${f.k}" ${currentVal===f.k?'selected':''}>${f.l}</option>`).join('')}
            </optgroup>
            <optgroup label="Custom Field">
              <option value="custom:${col.trim()}" ${isCustom?'selected':''}>Save as "${col.trim()}"</option>
            </optgroup>
          </select>
        </div>
      `}).join('');
      checkImportReady();
    }

    function updateMapping(idx, val) {
      state.importMap[idx] = val;
      checkImportReady();
    }

    function checkImportReady() {
      $('importConfirm').disabled = !Object.values(state.importMap).includes('email');
    }

    async function doImport() {
      if (!state.importData) return;
      const { h, r } = state.importData;

      const members = r.map(row => {
        const m = { custom_fields: {} };

        h.forEach((_, i) => {
          const mapping = state.importMap[i];
          const value = row[i]?.trim();
          if (!mapping || !value) return;

          if (mapping.startsWith('custom:')) {
            // Custom field - extract the field name and store in custom_fields
            const fieldName = mapping.substring(7);
            m.custom_fields[fieldName] = value;
          } else {
            // Standard field
            m[mapping] = value;
          }
        });

        // Only keep custom_fields if it has values
        if (Object.keys(m.custom_fields).length === 0) {
          delete m.custom_fields;
        }

        return m;
      }).filter(m => m.email);

      if (!members.length) { showToast('No valid rows to import', 'error'); return; }

      try {
        const res = await fetch('/api/v1/members/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ members })
        });
        const d = await res.json();
        const customCount = members.filter(m => m.custom_fields).length;
        let msg = `Imported ${d.imported} member${d.imported !== 1 ? 's' : ''}`;
        if (d.skipped) msg += `, ${d.skipped} skipped`;
        if (customCount) msg += ` (${customCount} with custom fields)`;
        showToast(msg);
        closeImport();
        state.members = await fetchMembers();
        updateInsights();
        applyFilter();
      } catch { showToast('Import failed', 'error'); }
    }

    // Member Panel
    function openPanel(id) {
      const m = state.members.find(x => x.id == id);
      if (!m) return;
      state.selected = m;

      $('panelBackdrop').classList.add('active');
      $('memberPanel').classList.add('active');

      $('panelAvatar').textContent = initials(m.first_name, m.last_name);
      $('panelName').textContent = `${m.first_name||''} ${m.last_name||''}`;
      $('panelEmail').textContent = m.email || '';

      const status = getStatus(m.status, m.expires_at);
      $('panelStatus').className = `status-badge ${status.cls}`;
      $('panelStatus').innerHTML = `<span class="status-dot"></span>${status.label}`;

      $('pEmail').textContent = m.email || '-';
      $('pPhone').textContent = m.phone || '-';
      $('pTier').textContent = m.tier_name || '-';
      $('pStatus').textContent = m.status || '-';
      $('pJoined').textContent = fmtDate(m.created_at);
      $('pExpires').textContent = fmtDate(m.expires_at);
      $('editLink').href = `/admin/member.html?id=${m.id}`;

      // Custom fields
      if (m.custom_fields && Object.keys(m.custom_fields).length > 0) {
        $('customFieldsSection').style.display = 'block';
        $('customFieldsGrid').innerHTML = Object.entries(m.custom_fields).map(([k, v]) => `
          <div class="custom-field-item">
            <span class="custom-field-key">${k}</span>
            <span class="custom-field-val">${v}</span>
          </div>
        `).join('');
      } else {
        $('customFieldsSection').style.display = 'none';
      }

      switchTab('profile');
      $('timeline').innerHTML = `
        <div class="timeline-item">
          <div class="timeline-date">${fmtDate(m.created_at)}</div>
          <div class="timeline-text">Joined the organization</div>
        </div>
      `;
    }

    function closePanel() {
      $('panelBackdrop').classList.remove('active');
      $('memberPanel').classList.remove('active');
      state.selected = null;
    }

    function switchTab(t) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === t));
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.toggle('active', p.id === `tab-${t}`));
    }

    async function deleteMember() {
      if (!state.selected) return;
      if (!confirm(`Delete ${state.selected.first_name} ${state.selected.last_name}? This cannot be undone.`)) return;
      try {
        const r = await fetch(`/api/v1/members/${state.selected.id}`, { method: 'DELETE', credentials: 'include' });
        if (r.ok) {
          showToast('Member deleted');
          closePanel();
          state.members = await fetchMembers();
          updateInsights();
          applyFilter();
        } else { showToast('Failed to delete member', 'error'); }
      } catch { showToast('Failed to delete member', 'error'); }
    }

    function addNote() {
      const txt = $('noteInput').value.trim();
      if (!txt) return;
      const list = $('notesList');
      if (list.querySelector('p')) list.innerHTML = '';
      list.insertAdjacentHTML('afterbegin', `
        <div class="note-item">
          <div class="note-header"><span class="note-author">You</span><span class="note-date">${fmtDate(new Date())}</span></div>
          <div class="note-text">${txt}</div>
        </div>
      `);
      $('noteInput').value = '';
      showToast('Note added');
    }

    // Export
    function exportCSV() {
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Status', 'Tier', 'Joined', 'Expires'];
      const rows = state.filtered.map(m => [
        m.first_name || '', m.last_name || '', m.email || '', m.phone || '',
        m.status || '', m.tier_name || '',
        m.created_at?.split('T')[0] || '', m.expires_at?.split('T')[0] || ''
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = `members-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      showToast(`Exported ${state.filtered.length} member${state.filtered.length !== 1 ? 's' : ''}`);
    }

    // Row click handler - navigates to member profile
    function goToMember(event, id) {
      // Only navigate if not clicking on checkbox
      if (event.target.type !== 'checkbox') {
        window.location.href = `/admin/member.html?id=${id}`;
      }
    }

    // Selection functions
    function toggleSelect(id, checked) {
      if (checked) {
        if (!state.selectedIds.includes(id)) state.selectedIds.push(id);
      } else {
        state.selectedIds = state.selectedIds.filter(x => x !== id);
      }
      updateBulkBar();
      render();
    }

    function toggleSelectAll(checked) {
      const start = (state.page - 1) * state.perPage;
      const end = start + state.perPage;
      const pageIds = state.filtered.slice(start, end).map(m => m.id);

      if (checked) {
        pageIds.forEach(id => {
          if (!state.selectedIds.includes(id)) state.selectedIds.push(id);
        });
      } else {
        state.selectedIds = state.selectedIds.filter(id => !pageIds.includes(id));
      }
      updateBulkBar();
      render();
    }

    function clearSelection() {
      state.selectedIds = [];
      updateBulkBar();
      render();
    }

    function updateBulkBar() {
      const bulkBar = $('bulkBar');
      const bulkCount = $('bulkCount');
      if (state.selectedIds.length > 0) {
        bulkBar.style.display = 'flex';
        bulkCount.textContent = state.selectedIds.length;
      } else {
        bulkBar.style.display = 'none';
      }
    }

    // Bulk actions
    function bulkExport() {
      const selected = state.members.filter(m => state.selectedIds.includes(m.id));
      if (!selected.length) return;

      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Status', 'Tier', 'Joined', 'Expires'];
      const rows = selected.map(m => [
        m.first_name || '', m.last_name || '', m.email || '', m.phone || '',
        m.status || '', m.tier_name || '',
        m.created_at?.split('T')[0] || '', m.expires_at?.split('T')[0] || ''
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = `members-selected-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      showToast(`Exported ${selected.length} member${selected.length !== 1 ? 's' : ''}`);
    }

    async function bulkChangeStatus(newStatus) {
      if (!state.selectedIds.length) return;
      if (!confirm(`Change status to "${newStatus}" for ${state.selectedIds.length} member${state.selectedIds.length !== 1 ? 's' : ''}?`)) return;

      let success = 0, failed = 0;
      for (const id of state.selectedIds) {
        try {
          const r = await fetch(`/api/v1/members/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: newStatus })
          });
          if (r.ok) success++; else failed++;
        } catch { failed++; }
      }

      if (success > 0) {
        showToast(`Updated ${success} member${success !== 1 ? 's' : ''}`);
        state.members = await fetchMembers();
        clearSelection();
        updateInsights();
        applyFilter();
      }
      if (failed > 0) showToast(`Failed to update ${failed} member${failed !== 1 ? 's' : ''}`, 'error');
    }

    async function bulkDelete() {
      if (!state.selectedIds.length) return;
      if (!confirm(`Delete ${state.selectedIds.length} member${state.selectedIds.length !== 1 ? 's' : ''}? This cannot be undone.`)) return;

      let success = 0, failed = 0;
      for (const id of state.selectedIds) {
        try {
          const r = await fetch(`/api/v1/members/${id}`, { method: 'DELETE', credentials: 'include' });
          if (r.ok) success++; else failed++;
        } catch { failed++; }
      }

      if (success > 0) {
        showToast(`Deleted ${success} member${success !== 1 ? 's' : ''}`);
        state.members = await fetchMembers();
        clearSelection();
        updateInsights();
        applyFilter();
      }
      if (failed > 0) showToast(`Failed to delete ${failed} member${failed !== 1 ? 's' : ''}`, 'error');
    }

    // Events
    function setupEvents() {
      $('searchInput').addEventListener('input', e => { state.search = e.target.value; applyFilter(); });

      document.addEventListener('keydown', e => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openCmd(); }
        if (e.key === 'Escape') { closeCmd(); closeAdd(); closeImport(); closePanel(); }
      });

      $('cmdBackdrop').onclick = closeCmd;
      $('cmdInput').addEventListener('input', e => renderCmd(e.target.value));

      document.querySelectorAll('.filter-pill').forEach(p => p.onclick = () => setFilter(p.dataset.filter));
      document.querySelectorAll('.insight-card').forEach(c => c.onclick = () => setFilter(c.dataset.filter));
      document.querySelectorAll('.data-table th[data-sort]').forEach(th => th.onclick = () => setSort(th.dataset.sort));
      document.querySelectorAll('.tab-btn').forEach(t => t.onclick = () => switchTab(t.dataset.tab));

      $('addBtn').onclick = openAdd;
      $('exportBtn').onclick = exportCSV;
      $('importBtn').onclick = openImport;

      $('addBackdrop').onclick = closeAdd;
      $('importBackdrop').onclick = closeImport;
      $('panelBackdrop').onclick = closePanel;

      $('addEmail').addEventListener('blur', checkDup);
      $('addPhone').addEventListener('blur', checkDup);

      $('dropzone').onclick = () => $('fileInput').click();
      $('fileInput').onchange = e => { if (e.target.files.length) handleFile(e.target.files[0]); };
      $('dropzone').ondragover = e => { e.preventDefault(); $('dropzone').classList.add('dragover'); };
      $('dropzone').ondragleave = () => $('dropzone').classList.remove('dragover');
      $('dropzone').ondrop = e => { e.preventDefault(); $('dropzone').classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); };
    }

    // Quick Actions Menu
    function showQuickActions(event, memberId) {
      const member = state.members.find(m => m.id == memberId);
      if (!member) return;

      quickActions.show(event, [
        {
          label: 'View Profile',
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>',
          onClick: () => window.location.href = `/admin/member.html?id=${memberId}`
        },
        {
          label: 'Send Email',
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
          onClick: () => window.location.href = `mailto:${member.email}`
        },
        {
          label: member.status === 'active' ? 'Mark as Expired' : 'Mark as Active',
          icon: member.status === 'active'
            ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
            : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
          onClick: async () => {
            const newStatus = member.status === 'active' ? 'expired' : 'active';
            try {
              const r = await fetch(`/api/v1/members/${memberId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ status: newStatus })
              });
              if (r.ok) {
                toast.success(`Member marked as ${newStatus}`);
                state.members = await fetchMembers();
                updateInsights();
                applyFilter();
              } else {
                toast.error('Failed to update member');
              }
            } catch {
              toast.error('Failed to update member');
            }
          }
        },
        { divider: true },
        {
          label: 'Delete',
          icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
          danger: true,
          onClick: async () => {
            const confirmed = await confirm2.danger(
              'Delete Member?',
              `This will permanently delete ${member.first_name} ${member.last_name} and all their data. This action cannot be undone.`
            );
            if (!confirmed) return;
            try {
              const r = await fetch(`/api/v1/members/${memberId}`, { method: 'DELETE', credentials: 'include' });
              if (r.ok) {
                toast.success('Member deleted');
                state.members = await fetchMembers();
                updateInsights();
                applyFilter();
              } else {
                toast.error('Failed to delete member');
              }
            } catch {
              toast.error('Failed to delete member');
            }
          }
        }
      ]);
    }

    init();
  </script>
</body>
</html>
