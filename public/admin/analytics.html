<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - VillageMembers Admin</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-main { flex: 1; margin-left: var(--sidebar-width); background-color: var(--bg-secondary); }
    @media (max-width: 768px) { .admin-main { margin-left: 0; padding-bottom: 4rem; } }
    .admin-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-4) var(--space-6); background-color: var(--bg-primary); border-bottom: 1px solid var(--border-color); }
    .admin-content { padding: var(--space-6); max-width: 1400px; }

    /* Page header */
    .page-header { margin-bottom: var(--space-6); }
    .page-header h1 { font-size: var(--text-2xl); margin-bottom: var(--space-1); }
    .page-header p { color: var(--text-secondary); }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6); }
    .kpi-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-5); }
    .kpi-label { font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-2); }
    .kpi-value { font-size: var(--text-3xl); font-weight: var(--font-bold); color: var(--text-primary); line-height: 1.2; }
    .kpi-change { display: flex; align-items: center; gap: var(--space-1); font-size: var(--text-sm); margin-top: var(--space-2); }
    .kpi-change.positive { color: var(--success); }
    .kpi-change.negative { color: var(--error); }
    .kpi-change.neutral { color: var(--text-tertiary); }
    .kpi-subtext { font-size: var(--text-xs); color: var(--text-tertiary); margin-top: var(--space-1); }

    /* Charts section */
    .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-6); margin-bottom: var(--space-6); }
    @media (max-width: 1024px) { .charts-grid { grid-template-columns: 1fr; } }

    .chart-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-5); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
    .chart-title { font-size: var(--text-lg); font-weight: var(--font-semibold); }
    .chart-subtitle { font-size: var(--text-sm); color: var(--text-secondary); }

    /* Bar chart */
    .bar-chart { display: flex; align-items: flex-end; gap: var(--space-2); height: 180px; padding-top: var(--space-4); }
    .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; }
    .bar-container { flex: 1; width: 100%; display: flex; flex-direction: column; justify-content: flex-end; }
    .bar { width: 100%; background: var(--terra-500); border-radius: var(--radius-sm) var(--radius-sm) 0 0; min-height: 4px; transition: all 0.3s ease; }
    .bar:hover { background: var(--terra-600); }
    .bar.secondary { background: var(--green-400); }
    .bar.secondary:hover { background: var(--green-500); }
    .bar-label { font-size: 10px; color: var(--text-tertiary); margin-top: var(--space-2); text-align: center; }
    .bar-value { font-size: 10px; font-weight: var(--font-medium); color: var(--text-secondary); margin-bottom: var(--space-1); text-align: center; }

    /* Horizontal bar chart */
    .h-bar-chart { display: flex; flex-direction: column; gap: var(--space-3); }
    .h-bar-row { display: flex; align-items: center; gap: var(--space-3); }
    .h-bar-label { width: 120px; font-size: var(--text-sm); color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .h-bar-track { flex: 1; height: 24px; background: var(--bg-secondary); border-radius: var(--radius-full); overflow: hidden; }
    .h-bar-fill { height: 100%; background: linear-gradient(90deg, var(--terra-400), var(--terra-600)); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: flex-end; padding-right: var(--space-2); transition: width 0.5s ease; }
    .h-bar-value { font-size: var(--text-xs); font-weight: var(--font-medium); color: white; }
    .h-bar-amount { width: 80px; text-align: right; font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--text-primary); }

    /* Metric grid */
    .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
    .metric-item { padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); }
    .metric-item-label { font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-1); }
    .metric-item-value { font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--text-primary); }
    .metric-item-subtext { font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-1); }

    /* Progress ring */
    .progress-ring-container { display: flex; align-items: center; gap: var(--space-4); }
    .progress-ring { width: 100px; height: 100px; }
    .progress-ring-bg { fill: none; stroke: var(--bg-secondary); stroke-width: 8; }
    .progress-ring-fill { fill: none; stroke: var(--terra-500); stroke-width: 8; stroke-linecap: round; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.5s ease; }
    .progress-ring-text { font-size: var(--text-2xl); font-weight: var(--font-bold); fill: var(--text-primary); }
    .progress-details { flex: 1; }
    .progress-stat { display: flex; justify-content: space-between; padding: var(--space-2) 0; border-bottom: 1px solid var(--border-light); }
    .progress-stat:last-child { border-bottom: none; }
    .progress-stat-label { font-size: var(--text-sm); color: var(--text-secondary); }
    .progress-stat-value { font-size: var(--text-sm); font-weight: var(--font-medium); }

    /* Insights section */
    .insights-section { margin-top: var(--space-6); }
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); }
    .insight-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-4); display: flex; gap: var(--space-3); }
    .insight-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .insight-icon.positive { background: var(--success-light); color: var(--success); }
    .insight-icon.warning { background: var(--warning-light); color: var(--warning); }
    .insight-icon.info { background: var(--primary-light); color: var(--primary); }
    .insight-content h4 { font-size: var(--text-sm); font-weight: var(--font-semibold); margin-bottom: var(--space-1); }
    .insight-content p { font-size: var(--text-sm); color: var(--text-secondary); }

    /* Loading state */
    .loading-placeholder { background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-md); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <a href="/admin/" style="color: white; font-size: var(--text-xl); font-weight: var(--font-bold);">VillageMembers</a>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
          Dashboard
        </a>
        <a href="/admin/analytics.html" class="sidebar-link active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
          Analytics
        </a>
        <a href="/admin/members.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          Members
        </a>
        <a href="/admin/tiers.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
          Tiers
        </a>
        <div class="sidebar-section">Credentials & CEU</div>
        <a href="/admin/credentials.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
          Credentials
        </a>
        <a href="/admin/ceu-credits.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
          Review Credits
        </a>
        <div class="sidebar-section">Community</div>
        <a href="/admin/moderation.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          Moderation
        </a>
        <div class="sidebar-section">Settings</div>
        <a href="/admin/settings.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"></path></svg>
          Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <div>
          <h2 style="font-size: var(--text-lg);">Analytics</h2>
        </div>
        <div style="display: flex; align-items: center; gap: var(--space-3);">
          <span id="user-email" style="font-size: var(--text-sm); color: var(--text-secondary);"></span>
        </div>
      </header>

      <div class="admin-content">
        <div class="page-header">
          <h1>Membership Analytics</h1>
          <p>Strategic insights to help you grow and retain your membership</p>
        </div>

        <!-- Key Performance Indicators -->
        <div class="kpi-grid" id="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Total Members</div>
            <div class="kpi-value" id="kpi-total">--</div>
            <div class="kpi-change neutral" id="kpi-total-change">Loading...</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Monthly Recurring Revenue</div>
            <div class="kpi-value" id="kpi-mrr">--</div>
            <div class="kpi-subtext">From active memberships</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Retention Rate</div>
            <div class="kpi-value" id="kpi-retention">--</div>
            <div class="kpi-subtext" id="kpi-retention-sub">Last 6 months</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Avg. Lifetime Value</div>
            <div class="kpi-value" id="kpi-ltv">--</div>
            <div class="kpi-subtext">Per member</div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-grid">
          <!-- Membership Trend -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Membership Growth</div>
                <div class="chart-subtitle">Total members over the last 12 months</div>
              </div>
            </div>
            <div class="bar-chart" id="membership-chart">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Revenue Trend -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Revenue Trend</div>
                <div class="chart-subtitle">Monthly revenue over the last 12 months</div>
              </div>
            </div>
            <div class="bar-chart" id="revenue-chart">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Second Charts Row -->
        <div class="charts-grid">
          <!-- Revenue by Tier -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Revenue by Tier</div>
                <div class="chart-subtitle">Monthly revenue contribution by membership tier</div>
              </div>
            </div>
            <div class="h-bar-chart" id="tier-chart">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Engagement & CEU -->
          <div class="chart-card">
            <div class="chart-header">
              <div>
                <div class="chart-title">Member Health</div>
                <div class="chart-subtitle">Engagement and compliance metrics</div>
              </div>
            </div>
            <div class="metric-grid" id="health-metrics">
              <div class="metric-item">
                <div class="metric-item-label">Active (30 days)</div>
                <div class="metric-item-value" id="metric-active30">--</div>
                <div class="metric-item-subtext" id="metric-active30-pct">-- of members</div>
              </div>
              <div class="metric-item">
                <div class="metric-item-label">Active (7 days)</div>
                <div class="metric-item-value" id="metric-active7">--</div>
                <div class="metric-item-subtext" id="metric-active7-pct">-- of members</div>
              </div>
              <div class="metric-item">
                <div class="metric-item-label">Inactive (90+ days)</div>
                <div class="metric-item-value" id="metric-inactive">--</div>
                <div class="metric-item-subtext" id="metric-inactive-pct">At risk of churning</div>
              </div>
              <div class="metric-item">
                <div class="metric-item-label">CEU Compliance</div>
                <div class="metric-item-value" id="metric-ceu">--</div>
                <div class="metric-item-subtext" id="metric-ceu-sub">Meeting requirements</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
          <h2 style="font-size: var(--text-lg); margin-bottom: var(--space-4);">Key Insights</h2>
          <div class="insights-grid" id="insights-grid">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
      <a href="/admin/" class="bottom-nav-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
        <span>Dashboard</span>
      </a>
      <a href="/admin/analytics.html" class="bottom-nav-link active">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        <span>Analytics</span>
      </a>
      <a href="/admin/members.html" class="bottom-nav-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
        <span>Members</span>
      </a>
      <a href="/admin/settings.html" class="bottom-nav-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6M12 17v6"></path></svg>
        <span>Settings</span>
      </a>
    </nav>
  </div>

  <script src="/js/app.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let data = null;

    async function checkAuth() {
      try {
        const res = await fetch('/api/v1/users/me', { credentials: 'include' });
        if (!res.ok) throw new Error('Not authenticated');
        const user = await res.json();
        document.getElementById('user-email').textContent = user.email;
        loadAnalytics();
      } catch (err) {
        window.location.href = '/admin/login.html';
      }
    }

    async function loadAnalytics() {
      try {
        const res = await fetch('/api/v1/analytics/overview', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load analytics');
        data = await res.json();
        renderKPIs();
        renderMembershipChart();
        renderRevenueChart();
        renderTierChart();
        renderHealthMetrics();
        renderInsights();
      } catch (err) {
        console.error('Analytics error:', err);
      }
    }

    function formatCurrency(cents) {
      return '$' + (cents / 100).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatPercent(value) {
      return parseFloat(value).toFixed(1) + '%';
    }

    function renderKPIs() {
      const { summary } = data;

      document.getElementById('kpi-total').textContent = summary.totalMembers.toLocaleString();

      const growthEl = document.getElementById('kpi-total-change');
      if (summary.growthRate > 0) {
        growthEl.className = 'kpi-change positive';
        growthEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="18 15 12 9 6 15"/></svg> ${summary.growthRate}% vs last month`;
      } else if (summary.growthRate < 0) {
        growthEl.className = 'kpi-change negative';
        growthEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"/></svg> ${Math.abs(summary.growthRate)}% vs last month`;
      } else {
        growthEl.className = 'kpi-change neutral';
        growthEl.textContent = 'No change vs last month';
      }

      document.getElementById('kpi-mrr').textContent = formatCurrency(summary.mrr);
      document.getElementById('kpi-retention').textContent = formatPercent(summary.retentionRate);
      document.getElementById('kpi-ltv').textContent = formatCurrency(summary.avgLifetimeValue);
    }

    function renderMembershipChart() {
      const { trends } = data;
      const chart = document.getElementById('membership-chart');
      const maxVal = Math.max(...trends.membership.map(m => m.total), 1);

      chart.innerHTML = trends.membership.map(m => {
        const month = new Date(m.month);
        const label = month.toLocaleDateString('en-US', { month: 'short' });
        const height = (m.total / maxVal) * 100;
        return `
          <div class="bar-group">
            <div class="bar-value">${m.total}</div>
            <div class="bar-container">
              <div class="bar" style="height: ${Math.max(height, 2)}%" title="${m.total} members"></div>
            </div>
            <div class="bar-label">${label}</div>
          </div>
        `;
      }).join('');
    }

    function renderRevenueChart() {
      const { trends } = data;
      const chart = document.getElementById('revenue-chart');
      const maxVal = Math.max(...trends.revenue.map(m => m.revenue), 1);

      chart.innerHTML = trends.revenue.map(m => {
        const month = new Date(m.month);
        const label = month.toLocaleDateString('en-US', { month: 'short' });
        const height = (m.revenue / maxVal) * 100;
        const amount = formatCurrency(m.revenue);
        return `
          <div class="bar-group">
            <div class="bar-value">${amount}</div>
            <div class="bar-container">
              <div class="bar secondary" style="height: ${Math.max(height, 2)}%" title="${amount}"></div>
            </div>
            <div class="bar-label">${label}</div>
          </div>
        `;
      }).join('');
    }

    function renderTierChart() {
      const { breakdown } = data;
      const chart = document.getElementById('tier-chart');
      const tiers = breakdown.byTier;
      const maxVal = Math.max(...tiers.map(t => t.monthlyRevenue), 1);

      if (tiers.length === 0) {
        chart.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: var(--space-4);">No tiers configured</div>';
        return;
      }

      chart.innerHTML = tiers.map(t => {
        const width = (t.monthlyRevenue / maxVal) * 100;
        return `
          <div class="h-bar-row">
            <div class="h-bar-label" title="${t.name}">${t.name}</div>
            <div class="h-bar-track">
              <div class="h-bar-fill" style="width: ${Math.max(width, 2)}%">
                <span class="h-bar-value">${t.activeCount}</span>
              </div>
            </div>
            <div class="h-bar-amount">${formatCurrency(t.monthlyRevenue)}/mo</div>
          </div>
        `;
      }).join('');
    }

    function renderHealthMetrics() {
      const { engagement, ceu } = data;
      const total = engagement.totalMembers || 1;

      document.getElementById('metric-active30').textContent = engagement.active30d;
      document.getElementById('metric-active30-pct').textContent = `${((engagement.active30d / total) * 100).toFixed(0)}% of members`;

      document.getElementById('metric-active7').textContent = engagement.active7d;
      document.getElementById('metric-active7-pct').textContent = `${((engagement.active7d / total) * 100).toFixed(0)}% of members`;

      document.getElementById('metric-inactive').textContent = engagement.inactive90d;
      document.getElementById('metric-inactive-pct').textContent = `${((engagement.inactive90d / total) * 100).toFixed(0)}% at risk of churning`;

      if (ceu.totalWithRequirements > 0) {
        document.getElementById('metric-ceu').textContent = formatPercent(ceu.complianceRate);
        document.getElementById('metric-ceu-sub').textContent = `${ceu.compliant} of ${ceu.totalWithRequirements} compliant`;
      } else {
        document.getElementById('metric-ceu').textContent = 'N/A';
        document.getElementById('metric-ceu-sub').textContent = 'No CEU requirements set';
      }
    }

    function renderInsights() {
      const insights = [];
      const { summary, engagement, ceu, breakdown } = data;

      // Growth insight
      if (summary.growthRate > 5) {
        insights.push({
          type: 'positive',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
          title: 'Strong Growth',
          text: `Your membership grew ${summary.growthRate}% this month. Keep up the momentum with referral campaigns.`
        });
      } else if (summary.growthRate < -5) {
        insights.push({
          type: 'warning',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
          title: 'Membership Declining',
          text: `Membership dropped ${Math.abs(summary.growthRate)}% this month. Consider a re-engagement campaign for lapsed members.`
        });
      }

      // Retention insight
      if (summary.retentionRate < 70) {
        insights.push({
          type: 'warning',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>',
          title: 'Retention Needs Attention',
          text: `Only ${summary.retentionRate}% of expiring members renewed. Focus on renewal reminders and value communication.`
        });
      } else if (summary.retentionRate > 85) {
        insights.push({
          type: 'positive',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
          title: 'Excellent Retention',
          text: `${summary.retentionRate}% retention rate is outstanding. Your members find real value in the organization.`
        });
      }

      // Engagement insight
      const engagementRate = (engagement.active30d / (engagement.totalMembers || 1)) * 100;
      if (engagementRate < 30) {
        insights.push({
          type: 'warning',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>',
          title: 'Low Engagement',
          text: `Only ${engagementRate.toFixed(0)}% of members logged in this month. Consider email campaigns or new community content.`
        });
      }

      // Inactive members insight
      if (engagement.inactive90d > 10) {
        insights.push({
          type: 'info',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
          title: `${engagement.inactive90d} Inactive Members`,
          text: `These members haven't logged in for 90+ days. A win-back campaign could recover valuable members.`
        });
      }

      // CEU compliance insight
      if (ceu.atRisk > 0) {
        insights.push({
          type: 'warning',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>',
          title: `${ceu.atRisk} Members at CEU Risk`,
          text: `These members have CEU deadlines in the next 30 days but haven't met requirements. Send reminders now.`
        });
      }

      // Top tier insight
      if (breakdown.byTier.length > 0) {
        const topTier = breakdown.byTier[0];
        insights.push({
          type: 'info',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
          title: `${topTier.name} Drives Most Revenue`,
          text: `This tier generates ${formatCurrency(topTier.monthlyRevenue)}/month from ${topTier.activeCount} active members.`
        });
      }

      // Render insights
      const grid = document.getElementById('insights-grid');
      if (insights.length === 0) {
        insights.push({
          type: 'positive',
          icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
          title: 'Looking Good!',
          text: 'Your membership metrics are healthy. Keep doing what you\'re doing!'
        });
      }

      grid.innerHTML = insights.map(insight => `
        <div class="insight-card">
          <div class="insight-icon ${insight.type}">${insight.icon}</div>
          <div class="insight-content">
            <h4>${insight.title}</h4>
            <p>${insight.text}</p>
          </div>
        </div>
      `).join('');
    }

    // Initialize
    checkAuth();
  </script>
</body>
</html>
