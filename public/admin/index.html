<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - VillageMembers Admin</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/components.css">

  <style>
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-main { flex: 1; margin-left: var(--sidebar-width); background-color: var(--bg-secondary); }
    @media (max-width: 768px) { .admin-main { margin-left: 0; padding-bottom: 4rem; } }
    .admin-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-4) var(--space-6); background-color: var(--bg-primary); border-bottom: 1px solid var(--border-color); }
    .admin-content { padding: var(--space-6); max-width: 1200px; }

    /* Greeting */
    .greeting { margin-bottom: var(--space-6); }
    .greeting h1 { font-size: var(--text-2xl); margin-bottom: var(--space-1); }
    .greeting .date { color: var(--text-secondary); }

    /* Priority section */
    .priorities-section { margin-bottom: var(--space-6); }
    .priorities-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); }
    .priorities-header h2 { font-size: var(--text-lg); margin: 0; display: flex; align-items: center; gap: var(--space-2); }
    .priority-count { display: inline-flex; align-items: center; justify-content: center; min-width: 24px; height: 24px; padding: 0 var(--space-2); background: var(--error); color: white; border-radius: var(--radius-full); font-size: var(--text-sm); font-weight: var(--font-bold); }
    .priority-count.low { background: var(--success); }

    /* Priority items */
    .priority-list { display: flex; flex-direction: column; gap: var(--space-3); }
    .priority-item { display: flex; align-items: flex-start; gap: var(--space-4); padding: var(--space-4); background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); transition: all 0.2s; }
    .priority-item:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .priority-item.critical { border-left: 4px solid var(--error); }
    .priority-item.high { border-left: 4px solid var(--warning); }
    .priority-item.medium { border-left: 4px solid var(--primary); }
    .priority-item.low { border-left: 4px solid var(--text-tertiary); }

    .priority-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .priority-icon.payment_failed { background: var(--error-light); color: var(--error); }
    .priority-icon.expiring_soon { background: var(--warning-light); color: var(--warning); }
    .priority-icon.recently_expired { background: var(--error-light); color: var(--error); }
    .priority-icon.ceu_deadline { background: var(--primary-light); color: var(--primary); }
    .priority-icon.pending { background: var(--bg-tertiary); color: var(--text-secondary); }
    .priority-icon.at_risk { background: var(--warning-light); color: var(--warning); }

    .priority-content { flex: 1; min-width: 0; }
    .priority-member { font-weight: var(--font-semibold); margin-bottom: var(--space-1); }
    .priority-member a { color: inherit; text-decoration: none; }
    .priority-member a:hover { color: var(--primary); }
    .priority-title { font-size: var(--text-sm); margin-bottom: var(--space-1); }
    .priority-context { font-size: var(--text-xs); color: var(--text-tertiary); }
    .priority-suggestion { font-size: var(--text-sm); color: var(--text-secondary); margin-top: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); }

    .priority-actions { display: flex; gap: var(--space-2); flex-shrink: 0; }
    .priority-action { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    .priority-action:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
    .priority-action.primary { background: var(--primary); color: white; border-color: var(--primary); }
    .priority-action.primary:hover { background: var(--primary-dark); }

    /* All clear state */
    .all-clear { text-align: center; padding: var(--space-8); background: var(--bg-primary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); }
    .all-clear-icon { width: 64px; height: 64px; margin: 0 auto var(--space-4); background: var(--success-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--success); }
    .all-clear h3 { margin: 0 0 var(--space-2); }
    .all-clear p { color: var(--text-secondary); margin: 0; }

    /* Stats row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6); }
    .stat-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-4); text-align: center; }
    .stat-value { font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--text-primary); }
    .stat-label { font-size: var(--text-xs); color: var(--text-tertiary); margin-top: var(--space-1); }
    .stat-change { font-size: var(--text-xs); margin-top: var(--space-2); }
    .stat-change.positive { color: var(--success); }

    /* Two column layout */
    .dashboard-grid { display: grid; grid-template-columns: 1fr 350px; gap: var(--space-6); }
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }

    /* Recent activity */
    .activity-list { display: flex; flex-direction: column; }
    .activity-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3) 0; border-bottom: 1px solid var(--border-light); }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .activity-text { flex: 1; font-size: var(--text-sm); }
    .activity-time { font-size: var(--text-xs); color: var(--text-tertiary); }

    /* Empty state */
    .empty-state { text-align: center; padding: var(--space-6); color: var(--text-tertiary); }

    /* Notification badge */
    .notif-badge {
      position: absolute;
      background: var(--error);
      color: white;
      font-size: 10px;
      font-weight: bold;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar (Desktop) -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <a href="/admin/" style="color: white; font-size: var(--text-xl); font-weight: var(--font-bold);">VillageMembers</a>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/" class="sidebar-link active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
          Dashboard
        </a>
        <a href="/admin/members.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          Members
        </a>
        <a href="/admin/tiers.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
          Tiers
        </a>
        <div class="sidebar-section">Community</div>
        <a href="/admin/moderation.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          Moderation
        </a>
        <div class="sidebar-section">Settings</div>
        <a href="/admin/settings.html" class="sidebar-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          Settings
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <div>
          <span id="org-name" class="text-sm text-muted">Loading...</span>
        </div>
        <div class="flex items-center gap-4">
          <span id="user-name" class="text-sm"></span>
          <button onclick="logout()" class="btn btn-ghost btn-sm">Logout</button>
        </div>
      </header>

      <div class="admin-content">
        <!-- Greeting -->
        <div class="greeting">
          <h1 id="greeting-text">Good morning</h1>
          <div class="date" id="date-text"></div>
        </div>

        <!-- Stats Row (Quick overview) -->
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="stat-active">-</div>
            <div class="stat-label">Active Members</div>
            <div class="stat-change positive" id="stat-active-change"></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-revenue">$0</div>
            <div class="stat-label">This Month</div>
            <div class="stat-change" id="stat-revenue-change"></div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-expiring">0</div>
            <div class="stat-label">Expiring Soon</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-label">Need Attention</div>
          </div>
        </div>

        <!-- Priorities Section -->
        <div class="priorities-section">
          <div class="priorities-header">
            <h2>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
              Needs Your Attention
              <span id="priority-count" class="priority-count" style="display: none;">0</span>
            </h2>
          </div>
          <div id="priorities-container" class="priority-list">
            <div class="empty-state">Loading...</div>
          </div>
        </div>

        <!-- Two column layout for secondary content -->
        <div class="dashboard-grid">
          <!-- Recent Members -->
          <div class="card card-shadow">
            <div class="card-header">
              <h3>Recent Members</h3>
              <a href="/admin/members.html" class="btn btn-ghost btn-sm">View all →</a>
            </div>
            <div class="card-body" id="recent-members">
              <div class="empty-state">Loading...</div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card card-shadow">
            <div class="card-header">
              <h3>Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="flex flex-col gap-2">
                <a href="/admin/members.html" class="btn btn-primary" style="width: 100%; justify-content: flex-start;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-2);"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                  Add New Member
                </a>
                <button onclick="openAnnouncementModal()" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-2);"><path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"></path></svg>
                  Send Announcement
                </button>
                <a href="/admin/tiers.html" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-2);"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                  Manage Tiers
                </a>
                <a href="/admin/moderation.html" class="btn btn-secondary" style="width: 100%; justify-content: flex-start; position: relative;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-2);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  Community Moderation
                  <span id="sidebar-mod-badge" class="notif-badge" style="display:none; position: absolute; right: 8px;">0</span>
                </a>
                <a href="/admin/settings.html" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: var(--space-2);"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                  Organization Settings
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Announcement Modal -->
    <div id="announce-modal-backdrop" class="modal-backdrop" onclick="closeModal('announce-modal')"></div>
    <div id="announce-modal" class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">Send Announcement</h3>
        <button class="modal-close" onclick="closeModal('announce-modal')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <form onsubmit="sendAnnouncement(event)">
        <div class="modal-body">
          <p class="text-muted mb-4">Send an in-app notification to all your members. They'll see it in their portal inbox.</p>
          <div class="form-group">
            <label class="label">Title *</label>
            <input type="text" id="announce-title" class="input" required placeholder="e.g., Annual Conference Registration Open">
          </div>
          <div class="form-group">
            <label class="label">Message</label>
            <textarea id="announce-body" class="input" rows="4" placeholder="Add more details (optional)"></textarea>
          </div>
          <div class="form-group">
            <label class="label">Link (optional)</label>
            <input type="url" id="announce-link" class="input" placeholder="https://...">
            <p class="helper-text">Members will be taken here when they click the notification</p>
          </div>
          <div class="form-group">
            <label class="label">Send to</label>
            <select id="announce-filter" class="input">
              <option value="all">All members</option>
              <option value="active">Active members only</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('announce-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Send to Members</button>
        </div>
      </form>
    </div>

    <!-- Bottom Nav (Mobile) -->
    <nav class="bottom-nav">
      <a href="/admin/" class="bottom-nav-link active">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
        Home
      </a>
      <a href="/admin/members.html" class="bottom-nav-link">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
        Members
      </a>
      <a href="/admin/moderation.html" class="bottom-nav-link" style="position: relative;">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        Moderation
        <span id="mod-badge" class="notif-badge" style="display:none; position: absolute; top: 4px; right: calc(50% - 30px);">0</span>
      </a>
      <a href="/admin/settings.html" class="bottom-nav-link">
        <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        Settings
      </a>
    </nav>
  </div>

  <script src="/js/app.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let currentUser = null;
    let currentOrg = null;

    async function checkAuth() {
      try {
        const res = await fetch('/auth/me', { credentials: 'include' });
        if (!res.ok) { window.location.href = '/login'; return; }
        const data = await res.json();
        if (data.type !== 'user') { window.location.href = '/login'; return; }
        currentUser = data;
        currentOrg = data.org;

        document.getElementById('org-name').textContent = currentOrg?.name || 'Your Organization';
        document.getElementById('user-name').textContent = currentUser?.name || currentUser?.email || 'Account';

        // Set greeting based on time of day
        const hour = new Date().getHours();
        let greeting = 'Good morning';
        if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
        else if (hour >= 17) greeting = 'Good evening';
        document.getElementById('greeting-text').textContent = `${greeting}, ${currentUser?.name?.split(' ')[0] || 'there'}`;

        // Set date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('date-text').textContent = new Date().toLocaleDateString('en-US', options);

        // Load data
        await Promise.all([
          loadDashboardStats(),
          loadPriorities(),
          loadModerationStats()
        ]);
      } catch (err) {
        window.location.href = '/login';
      }
    }

    async function loadDashboardStats() {
      try {
        const res = await fetch('/api/v1/dashboard/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load stats');
        const data = await res.json();

        // Active members
        document.getElementById('stat-active').textContent = data.members.active;
        if (data.members.newThisMonth > 0) {
          document.getElementById('stat-active-change').textContent = `+${data.members.newThisMonth} this month`;
        }

        // Revenue
        document.getElementById('stat-revenue').textContent = formatCurrency(data.revenue.thisMonth);
        if (data.revenue.transactionCount > 0) {
          document.getElementById('stat-revenue-change').textContent = `${data.revenue.transactionCount} transactions`;
          document.getElementById('stat-revenue-change').className = 'stat-change positive';
        }

        // Expiring (we'll update this from priorities)
        document.getElementById('stat-expiring').textContent = data.members.expired || '0';

        // Pending
        document.getElementById('stat-pending').textContent = data.members.pending || '0';

        // Recent members
        const recentContainer = document.getElementById('recent-members');
        if (data.recentMembers.length === 0) {
          recentContainer.innerHTML = '<div class="empty-state">No members yet. <a href="/admin/members.html">Add your first member</a></div>';
        } else {
          recentContainer.innerHTML = `
            <div class="activity-list">
              ${data.recentMembers.map(m => `
                <div class="activity-item" style="cursor: pointer;" onclick="viewMember('${m.id}')">
                  <div class="activity-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  </div>
                  <div class="activity-text">
                    <strong>${m.first_name || ''} ${m.last_name || ''}</strong>
                    <span class="text-muted" style="display: block;">${m.email}</span>
                  </div>
                  <span class="badge badge-${m.status === 'active' ? 'success' : 'default'}">${m.status}</span>
                </div>
              `).join('')}
            </div>
          `;
        }
      } catch (err) {
        console.error('Failed to load dashboard stats:', err);
      }
    }

    async function loadPriorities() {
      try {
        const res = await fetch('/api/v1/dashboard/priorities', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load priorities');
        const data = await res.json();

        const container = document.getElementById('priorities-container');
        const countEl = document.getElementById('priority-count');

        const criticalAndHigh = data.counts.critical + data.counts.high;

        if (data.priorities.length === 0) {
          countEl.style.display = 'none';

          // Check if we have any members at all
          const statsRes = await fetch('/api/v1/dashboard/stats', { credentials: 'include' });
          const stats = await statsRes.json();
          const totalMembers = stats.members?.total || 0;

          if (totalMembers === 0) {
            container.innerHTML = `
              <div class="all-clear">
                <div class="all-clear-icon" style="background: var(--primary-light); color: var(--primary);">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <h3>Ready to get started?</h3>
                <p>Add your first members or load demo data to explore the system.</p>
                <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4); justify-content: center;">
                  <a href="/admin/members.html" class="btn btn-primary">Add Member</a>
                  <button onclick="seedDemoData()" class="btn btn-secondary">Load Demo Data</button>
                </div>
              </div>
            `;
          } else {
            container.innerHTML = `
              <div class="all-clear">
                <div class="all-clear-icon">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <h3>All caught up!</h3>
                <p>No urgent items need your attention right now.</p>
              </div>
            `;
          }
          return;
        }

        // Show count badge
        countEl.style.display = 'inline-flex';
        countEl.textContent = criticalAndHigh || data.priorities.length;
        countEl.className = criticalAndHigh > 0 ? 'priority-count' : 'priority-count low';

        // Render priorities
        container.innerHTML = data.priorities.map(p => `
          <div class="priority-item ${p.severity}">
            <div class="priority-icon ${p.type}">
              ${getPriorityIcon(p.type)}
            </div>
            <div class="priority-content">
              <div class="priority-member">
                <a href="/admin/member.html?id=${p.member.id}">${p.member.name}</a>
                ${p.tierName ? `<span class="text-muted text-sm"> · ${p.tierName}</span>` : ''}
              </div>
              <div class="priority-title">${p.title}</div>
              ${p.context ? `<div class="priority-context">${p.context}</div>` : ''}
              <div class="priority-suggestion">${p.suggestion}</div>
            </div>
            <div class="priority-actions">
              ${p.member.phone ? `
                <a href="tel:${p.member.phone}" class="priority-action primary" title="Call">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                </a>
              ` : ''}
              <a href="/admin/member.html?id=${p.member.id}" class="priority-action" title="View Profile">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              </a>
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Failed to load priorities:', err);
        document.getElementById('priorities-container').innerHTML = '<div class="empty-state">Failed to load priorities</div>';
      }
    }

    function getPriorityIcon(type) {
      const icons = {
        'payment_failed': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
        'expiring_soon': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        'recently_expired': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        'ceu_deadline': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        'pending': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
        'at_risk': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
      };
      return icons[type] || icons['pending'];
    }

    function formatCurrency(cents) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0
      }).format(cents / 100);
    }

    function viewMember(id) {
      window.location.href = `/admin/member.html?id=${id}`;
    }

    async function logout() {
      await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/login';
    }

    async function seedDemoData() {
      if (!confirm('This will create 10 sample members and 3 membership tiers for testing. Continue?')) return;

      try {
        const res = await fetch('/api/v1/seed-demo-data', {
          method: 'POST',
          credentials: 'include'
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to seed data');
        }

        const data = await res.json();
        toast.success(data.message || 'Demo data loaded!');

        // Refresh the page to show the new data
        setTimeout(() => window.location.reload(), 1000);
      } catch (err) {
        toast.error(err.message);
      }
    }

    function openAnnouncementModal() {
      document.getElementById('announce-title').value = '';
      document.getElementById('announce-body').value = '';
      document.getElementById('announce-link').value = '';
      document.getElementById('announce-filter').value = 'all';
      document.getElementById('announce-modal').classList.add('active');
      document.getElementById('announce-modal-backdrop').classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      document.getElementById(modalId + '-backdrop').classList.remove('active');
    }

    async function sendAnnouncement(event) {
      event.preventDefault();

      const title = document.getElementById('announce-title').value.trim();
      const body = document.getElementById('announce-body').value.trim();
      const link = document.getElementById('announce-link').value.trim();
      const filter = document.getElementById('announce-filter').value;

      if (!title) {
        toast.error('Please enter a title');
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Sending...';
      submitBtn.disabled = true;

      try {
        const res = await fetch('/api/v1/community/admin/notifications/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            body: body || null,
            link: link || null,
            filter
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to send announcement');
        }

        const data = await res.json();
        toast.success(`Announcement sent to ${data.count} member${data.count !== 1 ? 's' : ''}!`);
        closeModal('announce-modal');
      } catch (err) {
        toast.error(err.message);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    async function loadModerationStats() {
      try {
        const res = await fetch('/api/v1/community/admin/moderation/stats', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();

        const pending = data.pendingReports || 0;

        // Update moderation badges
        const badges = ['mod-badge', 'sidebar-mod-badge'];
        badges.forEach(id => {
          const badge = document.getElementById(id);
          if (badge) {
            if (pending > 0) {
              badge.textContent = pending > 9 ? '9+' : pending;
              badge.style.display = 'flex';
            } else {
              badge.style.display = 'none';
            }
          }
        });
      } catch (err) {
        console.error('Failed to load moderation stats:', err);
      }
    }

    checkAuth();
  </script>
</body>
</html>
