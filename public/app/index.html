<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VillageMembers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/components.css">
  <style>
    /* Fresh Admin Layout */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      line-height: var(--leading-normal);
    }

    /* Main Layout - No sidebar, breathing room */
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Top Bar - Minimal, functional */
    .topbar {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: var(--space-3) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
    }

    .topbar-brand {
      font-weight: var(--font-semibold);
      color: var(--green-700);
      font-size: var(--text-lg);
    }

    .topbar-nav {
      display: flex;
      gap: var(--space-1);
    }

    .topbar-link {
      padding: var(--space-2) var(--space-3);
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
      text-decoration: none;
    }

    .topbar-link:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .topbar-link.active {
      background: var(--green-50);
      color: var(--green-700);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    /* Search - Always Visible, Primary */
    .search-container {
      position: relative;
      width: 320px;
    }

    .search-input {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      padding-left: var(--space-10);
      font-size: var(--text-sm);
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
    }

    .search-input:focus {
      background: var(--bg-primary);
      border-color: var(--green-500);
      box-shadow: 0 0 0 3px rgba(74, 124, 74, 0.15);
      outline: none;
    }

    .search-input::placeholder {
      color: var(--gray-400);
    }

    .search-icon {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-400);
      width: 18px;
      height: 18px;
    }

    .search-shortcut {
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      font-size: var(--text-xs);
      color: var(--gray-400);
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: var(--space-6);
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    /* Page Header */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
    }

    .page-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }

    .page-subtitle {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    /* Attention Bar - What needs you now */
    .attention-bar {
      background: var(--warning-light);
      border: 1px solid var(--terra-200);
      border-radius: var(--radius-xl);
      padding: var(--space-4) var(--space-6);
      margin-bottom: var(--space-6);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .attention-bar.hidden {
      display: none;
    }

    .attention-icon {
      color: var(--terra-500);
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .attention-content {
      flex: 1;
    }

    .attention-title {
      font-weight: var(--font-medium);
      color: var(--terra-700);
      font-size: var(--text-sm);
    }

    .attention-items {
      display: flex;
      gap: var(--space-4);
      margin-top: var(--space-2);
      flex-wrap: wrap;
    }

    .attention-item {
      font-size: var(--text-sm);
      color: var(--terra-600);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
    }

    .attention-item:hover {
      color: var(--terra-800);
    }

    /* Member Table Container */
    .table-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }

    .table-toolbar {
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
    }

    .table-filters {
      display: flex;
      gap: var(--space-2);
    }

    .filter-btn {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .filter-btn:hover {
      background: var(--bg-primary);
      border-color: var(--border-color-strong);
    }

    .filter-btn.active {
      background: var(--green-50);
      border-color: var(--green-300);
      color: var(--green-700);
    }

    .table-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* The Data Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      user-select: none;
      transition: background var(--transition-fast);
      white-space: nowrap;
    }

    .data-table th:hover {
      background: var(--gray-200);
    }

    .data-table th.sorted {
      color: var(--green-700);
    }

    .sort-icon {
      display: inline-block;
      margin-left: var(--space-1);
      opacity: 0.5;
    }

    .data-table th.sorted .sort-icon {
      opacity: 1;
    }

    .data-table td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    .data-table tbody tr {
      transition: background var(--transition-fast);
    }

    .data-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* Clickable Row */
    .data-table tbody tr {
      cursor: pointer;
    }

    /* Inline Editable Cell */
    .editable-cell {
      padding: var(--space-1);
      margin: calc(-1 * var(--space-1));
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
    }

    .editable-cell:hover {
      background: var(--green-50);
    }

    .editable-cell.editing {
      background: var(--bg-primary);
      box-shadow: 0 0 0 2px var(--green-500);
    }

    .editable-input {
      width: 100%;
      padding: var(--space-1) var(--space-2);
      font-size: inherit;
      font-family: inherit;
      border: none;
      background: transparent;
      outline: none;
    }

    /* Member Avatar & Name */
    .member-cell {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .member-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      background: var(--green-100);
      color: var(--green-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      flex-shrink: 0;
    }

    .member-info {
      min-width: 0;
    }

    .member-name {
      font-weight: var(--font-medium);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .member-email {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      border-radius: var(--radius-full);
    }

    .status-active {
      background: var(--success-light);
      color: var(--green-700);
    }

    .status-expiring {
      background: var(--warning-light);
      color: var(--terra-700);
    }

    .status-expired {
      background: var(--error-light);
      color: var(--error);
    }

    .status-pending {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    /* Table Footer */
    .table-footer {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
    }

    .table-info {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    /* Command Palette (Modal Search) */
    .command-palette-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal);
    }

    .command-palette-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .command-palette {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 600px;
      max-width: calc(100% - var(--space-8));
      max-height: 70vh;
      overflow: hidden;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .command-palette.open {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) scale(1);
    }

    .command-input-wrapper {
      padding: var(--space-4);
      border-bottom: 1px solid var(--border-color);
    }

    .command-input {
      width: 100%;
      padding: var(--space-3);
      font-size: var(--text-lg);
      border: none;
      outline: none;
      background: transparent;
    }

    .command-input::placeholder {
      color: var(--gray-400);
    }

    .command-results {
      max-height: 400px;
      overflow-y: auto;
      padding: var(--space-2);
    }

    .command-section {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .command-item {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      transition: background var(--transition-fast);
    }

    .command-item:hover,
    .command-item.selected {
      background: var(--bg-secondary);
    }

    .command-item-icon {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    .command-item-text {
      flex: 1;
    }

    .command-item-title {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }

    .command-item-subtitle {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .command-item-shortcut {
      font-size: var(--text-xs);
      color: var(--gray-400);
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-16);
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-4);
      color: var(--gray-300);
    }

    .empty-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .empty-text {
      color: var(--text-secondary);
      margin-bottom: var(--space-6);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .toast {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--error);
    }

    /* Modal Base Styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-modal-backdrop);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal);
    }

    .modal-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      width: 500px;
      max-width: calc(100% - var(--space-8));
      max-height: calc(100vh - var(--space-16));
      overflow: hidden;
      z-index: var(--z-modal);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .modal.open {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .modal-header {
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-2);
      color: var(--gray-400);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-6);
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .modal-footer {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
      background: var(--bg-secondary);
    }

    /* Form Styles */
    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .form-label-optional {
      font-weight: var(--font-normal);
      color: var(--text-secondary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      font-family: inherit;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--green-500);
      box-shadow: 0 0 0 3px rgba(74, 124, 74, 0.15);
    }

    .form-input.error,
    .form-select.error {
      border-color: var(--error);
    }

    .form-error {
      font-size: var(--text-xs);
      color: var(--error);
      margin-top: var(--space-1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .form-hint {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    /* Slide-over Panel (Member Detail) */
    .slide-over-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-modal-backdrop);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal);
    }

    .slide-over-backdrop.open {
      opacity: 1;
      visibility: visible;
    }

    .slide-over {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 600px;
      max-width: 100%;
      background: var(--bg-primary);
      box-shadow: var(--shadow-xl);
      z-index: var(--z-modal);
      transform: translateX(100%);
      transition: transform var(--transition-normal);
      display: flex;
      flex-direction: column;
    }

    .slide-over.open {
      transform: translateX(0);
    }

    .slide-over-header {
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .slide-over-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }

    .slide-over-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-6);
    }

    /* Member Detail Styles */
    .member-detail-header {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .member-detail-avatar {
      width: 72px;
      height: 72px;
      border-radius: var(--radius-full);
      background: var(--green-100);
      color: var(--green-700);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-2xl);
      font-weight: var(--font-semibold);
      flex-shrink: 0;
    }

    .member-detail-info h2 {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }

    .member-detail-info p {
      color: var(--text-secondary);
      font-size: var(--text-sm);
    }

    .member-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: var(--space-6);
    }

    .member-tab {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color var(--transition-fast);
    }

    .member-tab:hover {
      color: var(--text-primary);
    }

    .member-tab.active {
      color: var(--green-700);
    }

    .member-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--green-500);
    }

    .member-tab-content {
      display: none;
    }

    .member-tab-content.active {
      display: block;
    }

    .detail-section {
      margin-bottom: var(--space-6);
    }

    .detail-section-title {
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: var(--space-3);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .detail-item label {
      display: block;
      font-size: var(--text-xs);
      color: var(--text-secondary);
      margin-bottom: var(--space-1);
    }

    .detail-item-value {
      font-size: var(--text-sm);
      color: var(--text-primary);
      padding: var(--space-2) 0;
      border-bottom: 1px solid transparent;
      transition: all var(--transition-fast);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .detail-item-value:hover {
      background: var(--green-50);
      padding-left: var(--space-2);
      margin-left: calc(-1 * var(--space-2));
    }

    .detail-item-value.editing {
      background: var(--bg-primary);
      border-bottom-color: var(--green-500);
    }

    /* Import Modal - Wider */
    .modal.modal-lg {
      width: 700px;
    }

    .import-dropzone {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--space-10);
      text-align: center;
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .import-dropzone:hover,
    .import-dropzone.dragover {
      border-color: var(--green-500);
      background: var(--green-50);
    }

    .import-dropzone-icon {
      width: 48px;
      height: 48px;
      color: var(--gray-300);
      margin: 0 auto var(--space-4);
    }

    .import-dropzone-text {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .import-dropzone-text strong {
      color: var(--green-600);
    }

    .import-preview {
      margin-top: var(--space-6);
    }

    .import-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }

    .import-preview-title {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }

    .import-preview-count {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .import-preview-table {
      width: 100%;
      font-size: var(--text-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .import-preview-table th,
    .import-preview-table td {
      padding: var(--space-2) var(--space-3);
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .import-preview-table th {
      background: var(--bg-secondary);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
    }

    .import-preview-table tr:last-child td {
      border-bottom: none;
    }

    .import-mapping {
      margin-top: var(--space-6);
    }

    .import-mapping-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-3);
      align-items: center;
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .import-mapping-arrow {
      color: var(--text-secondary);
    }

    /* Duplicate Detection Styles */
    .duplicate-alert {
      background: var(--warning-light);
      border: 1px solid var(--terra-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3) var(--space-4);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .duplicate-alert-icon {
      width: 20px;
      height: 20px;
      color: var(--terra-500);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .duplicate-alert-content {
      flex: 1;
    }

    .duplicate-alert-title {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--terra-700);
    }

    .duplicate-alert-text {
      font-size: var(--text-xs);
      color: var(--terra-600);
      margin-top: var(--space-1);
    }

    .duplicate-alert-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-2);
    }

    /* Timeline Styles */
    .timeline {
      position: relative;
      padding-left: var(--space-6);
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-color);
    }

    .timeline-item {
      position: relative;
      padding-bottom: var(--space-4);
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: calc(-1 * var(--space-6) - 1px);
      top: 0;
      width: 10px;
      height: 10px;
      border-radius: var(--radius-full);
      background: var(--bg-primary);
      border: 2px solid var(--green-500);
    }

    .timeline-item-date {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      margin-bottom: var(--space-1);
    }

    .timeline-item-content {
      font-size: var(--text-sm);
      color: var(--text-primary);
    }

    /* Notes Styles */
    .note-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
    }

    .note-card-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-2);
    }

    .note-card-author {
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      color: var(--text-primary);
    }

    .note-card-date {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .note-card-content {
      font-size: var(--text-sm);
      color: var(--text-primary);
    }

    .add-note-form {
      margin-top: var(--space-4);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      font-family: inherit;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid transparent;
    }

    .btn-primary {
      background: var(--green-500);
      color: white;
      border-color: var(--green-500);
    }

    .btn-primary:hover {
      background: var(--green-600);
      border-color: var(--green-600);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--border-color-strong);
    }

    .btn-danger {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }

    .btn-danger:hover {
      background: #A62626;
    }

    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: none;
    }

    .btn-ghost:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* Pagination styling */
    .pagination {
      display: flex;
      gap: var(--space-1);
    }

    .pagination-btn {
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-sm);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--bg-secondary);
    }

    .pagination-btn.active {
      background: var(--green-500);
      color: white;
      border-color: var(--green-500);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .topbar {
        padding: var(--space-3) var(--space-4);
      }

      .topbar-nav {
        display: none;
      }

      .search-container {
        width: 100%;
        max-width: 200px;
      }

      .search-shortcut {
        display: none;
      }

      .main {
        padding: var(--space-4);
      }

      .table-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .table-filters {
        overflow-x: auto;
        padding-bottom: var(--space-2);
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
      }

      .data-table {
        font-size: var(--text-sm);
      }

      .data-table th,
      .data-table td {
        padding: var(--space-2) var(--space-3);
      }

      .member-avatar {
        width: 32px;
        height: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Top Bar -->
    <header class="topbar">
      <div class="topbar-brand">VillageMembers</div>

      <nav class="topbar-nav">
        <a href="#" class="topbar-link active">Members</a>
        <a href="#" class="topbar-link">Tiers</a>
        <a href="#" class="topbar-link">Automations</a>
        <a href="#" class="topbar-link">Settings</a>
      </nav>

      <div class="topbar-right">
        <div class="search-container">
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input
            type="text"
            class="search-input"
            placeholder="Search members..."
            id="searchInput"
          >
          <span class="search-shortcut">Ctrl+K</span>
        </div>
        <button class="btn btn-primary" id="addMemberBtn">+ Add Member</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h1 class="page-title">Members</h1>
          <p class="page-subtitle" id="memberCount">Loading...</p>
        </div>
        <div class="table-actions">
          <button class="btn btn-secondary" id="exportBtn">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Export
          </button>
          <button class="btn btn-secondary" id="importBtn">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Import
          </button>
        </div>
      </div>

      <!-- Attention Bar -->
      <div class="attention-bar" id="attentionBar">
        <svg class="attention-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <div class="attention-content">
          <div class="attention-title">Needs your attention</div>
          <div class="attention-items" id="attentionItems">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- Member Table -->
      <div class="table-card">
        <div class="table-toolbar">
          <div class="table-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="active">Active</button>
            <button class="filter-btn" data-filter="expiring">Expiring Soon</button>
            <button class="filter-btn" data-filter="expired">Expired</button>
            <button class="filter-btn" data-filter="pending">Pending</button>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table" id="memberTable">
            <thead>
              <tr>
                <th data-sort="name" class="sorted">Name <span class="sort-icon">↑</span></th>
                <th data-sort="email">Email <span class="sort-icon">↕</span></th>
                <th data-sort="status">Status <span class="sort-icon">↕</span></th>
                <th data-sort="tier">Tier <span class="sort-icon">↕</span></th>
                <th data-sort="expires">Expires <span class="sort-icon">↕</span></th>
                <th data-sort="joined">Joined <span class="sort-icon">↕</span></th>
              </tr>
            </thead>
            <tbody id="memberTableBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="table-info" id="tableInfo">Showing 1-20 of 523 members</div>
          <div class="pagination" id="pagination">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </main>

    <!-- Command Palette -->
    <div class="command-palette-backdrop" id="commandBackdrop"></div>
    <div class="command-palette" id="commandPalette">
      <div class="command-input-wrapper">
        <input type="text" class="command-input" placeholder="Search members, actions, or settings..." id="commandInput">
      </div>
      <div class="command-results" id="commandResults">
        <div class="command-section">Recent Members</div>
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Add Member Modal -->
    <div class="modal-backdrop" id="addMemberBackdrop"></div>
    <div class="modal" id="addMemberModal">
      <div class="modal-header">
        <h3 class="modal-title">Add Member</h3>
        <button class="modal-close" onclick="closeAddMemberModal()">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="duplicateWarning" class="duplicate-alert" style="display: none;">
          <svg class="duplicate-alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
          <div class="duplicate-alert-content">
            <div class="duplicate-alert-title">Possible duplicate found</div>
            <div class="duplicate-alert-text" id="duplicateDetails"></div>
            <div class="duplicate-alert-actions">
              <button class="btn btn-sm btn-secondary" onclick="viewDuplicate()">View existing</button>
              <button class="btn btn-sm btn-ghost" onclick="ignoreDuplicate()">Continue anyway</button>
            </div>
          </div>
        </div>
        <form id="addMemberForm" onsubmit="handleAddMember(event)">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" class="form-input" name="first_name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-input" name="last_name" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" name="email" required id="newMemberEmail">
            <div class="form-error" id="emailError" style="display: none;"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Phone <span class="form-label-optional">(optional)</span></label>
            <input type="tel" class="form-input" name="phone" id="newMemberPhone">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Membership Tier</label>
              <select class="form-select" name="tier_id" id="tierSelect">
                <option value="">Select tier...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select class="form-select" name="status">
                <option value="active">Active</option>
                <option value="pending">Pending</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Expiration Date <span class="form-label-optional">(optional)</span></label>
            <input type="date" class="form-input" name="expires_at">
            <div class="form-hint">Leave blank for no expiration</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddMemberModal()">Cancel</button>
        <button class="btn btn-primary" onclick="document.getElementById('addMemberForm').requestSubmit()">Add Member</button>
      </div>
    </div>

    <!-- Import CSV Modal -->
    <div class="modal-backdrop" id="importBackdrop"></div>
    <div class="modal modal-lg" id="importModal">
      <div class="modal-header">
        <h3 class="modal-title">Import Members</h3>
        <button class="modal-close" onclick="closeImportModal()">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="importDropzone" class="import-dropzone">
          <svg class="import-dropzone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p class="import-dropzone-text">
            <strong>Click to upload</strong> or drag and drop<br>
            CSV file up to 10MB
          </p>
          <input type="file" id="importFileInput" accept=".csv" style="display: none;">
        </div>

        <div id="importPreview" class="import-preview" style="display: none;">
          <div class="import-preview-header">
            <span class="import-preview-title">Preview</span>
            <span class="import-preview-count" id="importPreviewCount"></span>
          </div>
          <table class="import-preview-table">
            <thead id="importPreviewHead"></thead>
            <tbody id="importPreviewBody"></tbody>
          </table>

          <div class="import-mapping">
            <div class="detail-section-title">Column Mapping</div>
            <div id="importMappingRows"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button class="btn btn-primary" id="importConfirmBtn" disabled onclick="handleImport()">Import Members</button>
      </div>
    </div>

    <!-- Member Detail Slide-over -->
    <div class="slide-over-backdrop" id="memberDetailBackdrop"></div>
    <div class="slide-over" id="memberDetailPanel">
      <div class="slide-over-header">
        <h3 class="slide-over-title">Member Details</h3>
        <button class="modal-close" onclick="closeMemberDetail()">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="slide-over-body">
        <div class="member-detail-header">
          <div class="member-detail-avatar" id="detailAvatar">JD</div>
          <div class="member-detail-info">
            <h2 id="detailName">John Doe</h2>
            <p id="detailEmail">john@example.com</p>
            <span class="status-badge status-active" id="detailStatus">Active</span>
          </div>
        </div>

        <div class="member-tabs">
          <button class="member-tab active" data-tab="profile">Profile</button>
          <button class="member-tab" data-tab="timeline">Timeline</button>
          <button class="member-tab" data-tab="notes">Notes</button>
        </div>

        <!-- Profile Tab -->
        <div class="member-tab-content active" id="tab-profile">
          <div class="detail-section">
            <div class="detail-section-title">Contact Information</div>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Email</label>
                <div class="detail-item-value" data-field="email" id="detail-email">-</div>
              </div>
              <div class="detail-item">
                <label>Phone</label>
                <div class="detail-item-value" data-field="phone" id="detail-phone">-</div>
              </div>
              <div class="detail-item">
                <label>Address</label>
                <div class="detail-item-value" data-field="address" id="detail-address">-</div>
              </div>
              <div class="detail-item">
                <label>City, State</label>
                <div class="detail-item-value" id="detail-city-state">-</div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">Membership</div>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Tier</label>
                <div class="detail-item-value" id="detail-tier">-</div>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <div class="detail-item-value" id="detail-member-status">-</div>
              </div>
              <div class="detail-item">
                <label>Joined</label>
                <div class="detail-item-value" id="detail-joined">-</div>
              </div>
              <div class="detail-item">
                <label>Expires</label>
                <div class="detail-item-value" id="detail-expires">-</div>
              </div>
            </div>
          </div>

          <div class="detail-section" style="margin-top: var(--space-8);">
            <button class="btn btn-danger btn-sm" onclick="confirmDeleteMember()">Delete Member</button>
          </div>
        </div>

        <!-- Timeline Tab -->
        <div class="member-tab-content" id="tab-timeline">
          <div class="timeline" id="memberTimeline">
            <div class="timeline-item">
              <div class="timeline-item-date">Loading...</div>
              <div class="timeline-item-content">Fetching activity history...</div>
            </div>
          </div>
        </div>

        <!-- Notes Tab -->
        <div class="member-tab-content" id="tab-notes">
          <div id="memberNotes">
            <p style="color: var(--text-secondary); font-size: var(--text-sm);">No notes yet.</p>
          </div>
          <div class="add-note-form">
            <textarea class="form-textarea" id="newNoteText" placeholder="Add a note..." rows="3"></textarea>
            <button class="btn btn-primary btn-sm" style="margin-top: var(--space-2);" onclick="addNote()">Add Note</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===========================================
    // VillageMembers - Fresh Admin Interface
    // ===========================================

    // State
    const state = {
      members: [],
      filteredMembers: [],
      tiers: [],
      currentFilter: 'all',
      sortColumn: 'name',
      sortDirection: 'asc',
      searchQuery: '',
      page: 1,
      perPage: 20,
      loading: true,
      selectedMember: null,
      importData: null,
      importMapping: {},
      duplicateFound: null,
      ignoreDuplicates: false
    };

    // DOM Elements
    const elements = {
      memberTableBody: document.getElementById('memberTableBody'),
      memberCount: document.getElementById('memberCount'),
      tableInfo: document.getElementById('tableInfo'),
      pagination: document.getElementById('pagination'),
      searchInput: document.getElementById('searchInput'),
      commandPalette: document.getElementById('commandPalette'),
      commandBackdrop: document.getElementById('commandBackdrop'),
      commandInput: document.getElementById('commandInput'),
      commandResults: document.getElementById('commandResults'),
      attentionBar: document.getElementById('attentionBar'),
      attentionItems: document.getElementById('attentionItems'),
      toastContainer: document.getElementById('toastContainer'),
      // Modals
      addMemberModal: document.getElementById('addMemberModal'),
      addMemberBackdrop: document.getElementById('addMemberBackdrop'),
      addMemberForm: document.getElementById('addMemberForm'),
      importModal: document.getElementById('importModal'),
      importBackdrop: document.getElementById('importBackdrop'),
      // Slide-over
      memberDetailPanel: document.getElementById('memberDetailPanel'),
      memberDetailBackdrop: document.getElementById('memberDetailBackdrop')
    };

    // ===========================================
    // API Functions
    // ===========================================

    async function fetchMembers() {
      try {
        const response = await fetch('/api/v1/members', {
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to fetch members');
        const data = await response.json();
        return data.members || [];
      } catch (error) {
        console.error('Error fetching members:', error);
        return [];
      }
    }

    async function fetchTiers() {
      try {
        const response = await fetch('/api/v1/tiers', {
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to fetch tiers');
        const data = await response.json();
        return data.tiers || [];
      } catch (error) {
        console.error('Error fetching tiers:', error);
        return [];
      }
    }

    async function createMember(memberData) {
      try {
        const response = await fetch('/api/v1/members', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(memberData)
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to create member');
        }
        return await response.json();
      } catch (error) {
        throw error;
      }
    }

    async function updateMember(id, data) {
      try {
        const response = await fetch(`/api/v1/members/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error('Failed to update member');
        showToast('Member updated', 'success');
        return true;
      } catch (error) {
        console.error('Error updating member:', error);
        showToast('Failed to update member', 'error');
        return false;
      }
    }

    async function deleteMember(id) {
      try {
        const response = await fetch(`/api/v1/members/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to delete member');
        return true;
      } catch (error) {
        console.error('Error deleting member:', error);
        return false;
      }
    }

    async function importMembers(members) {
      try {
        const response = await fetch('/api/v1/members/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ members })
        });
        if (!response.ok) throw new Error('Failed to import members');
        return await response.json();
      } catch (error) {
        throw error;
      }
    }

    // ===========================================
    // Duplicate Detection
    // ===========================================

    function findDuplicates(email, phone) {
      const duplicates = [];
      const emailLower = (email || '').toLowerCase().trim();
      const phoneClean = (phone || '').replace(/\D/g, '');

      for (const member of state.members) {
        const memberEmail = (member.email || '').toLowerCase().trim();
        const memberPhone = (member.phone || '').replace(/\D/g, '');

        if (emailLower && memberEmail === emailLower) {
          duplicates.push({ member, reason: 'email', confidence: 'high' });
        } else if (phoneClean && phoneClean.length >= 10 && memberPhone === phoneClean) {
          duplicates.push({ member, reason: 'phone', confidence: 'high' });
        }
      }

      return duplicates;
    }

    function checkForDuplicates() {
      if (state.ignoreDuplicates) return;

      const email = document.getElementById('newMemberEmail').value;
      const phone = document.getElementById('newMemberPhone').value;
      const duplicates = findDuplicates(email, phone);

      const warning = document.getElementById('duplicateWarning');
      const details = document.getElementById('duplicateDetails');

      if (duplicates.length > 0) {
        const dup = duplicates[0];
        state.duplicateFound = dup.member;
        details.textContent = `${dup.member.first_name} ${dup.member.last_name} (${dup.member.email}) - matched by ${dup.reason}`;
        warning.style.display = 'flex';
      } else {
        state.duplicateFound = null;
        warning.style.display = 'none';
      }
    }

    function viewDuplicate() {
      if (state.duplicateFound) {
        closeAddMemberModal();
        openMemberDetail(state.duplicateFound.id);
      }
    }

    function ignoreDuplicate() {
      state.ignoreDuplicates = true;
      document.getElementById('duplicateWarning').style.display = 'none';
    }

    // ===========================================
    // Render Functions
    // ===========================================

    function getInitials(firstName, lastName) {
      return `${(firstName || '')[0] || ''}${(lastName || '')[0] || ''}`.toUpperCase() || '?';
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getStatusClass(status, expiresAt) {
      if (status === 'expired') return 'status-expired';
      if (status === 'pending') return 'status-pending';
      if (expiresAt) {
        const daysUntil = Math.ceil((new Date(expiresAt) - new Date()) / (1000 * 60 * 60 * 24));
        if (daysUntil <= 30 && daysUntil > 0) return 'status-expiring';
      }
      return 'status-active';
    }

    function getStatusLabel(status, expiresAt) {
      if (status === 'expired') return 'Expired';
      if (status === 'pending') return 'Pending';
      if (expiresAt) {
        const daysUntil = Math.ceil((new Date(expiresAt) - new Date()) / (1000 * 60 * 60 * 24));
        if (daysUntil <= 30 && daysUntil > 0) return `Expires in ${daysUntil}d`;
      }
      return 'Active';
    }

    function renderMemberRow(member) {
      const statusClass = getStatusClass(member.status, member.expires_at);
      const statusLabel = getStatusLabel(member.status, member.expires_at);

      return `
        <tr data-id="${member.id}" onclick="openMemberDetail('${member.id}')">
          <td>
            <div class="member-cell">
              <div class="member-avatar">${getInitials(member.first_name, member.last_name)}</div>
              <div class="member-info">
                <div class="member-name">${member.first_name || ''} ${member.last_name || ''}</div>
                <div class="member-email">${member.email || ''}</div>
              </div>
            </div>
          </td>
          <td>
            <span class="editable-cell" data-field="email" data-id="${member.id}">${member.email || '-'}</span>
          </td>
          <td>
            <span class="status-badge ${statusClass}">${statusLabel}</span>
          </td>
          <td>${member.tier_name || '-'}</td>
          <td>${formatDate(member.expires_at)}</td>
          <td>${formatDate(member.created_at)}</td>
        </tr>
      `;
    }

    function renderTable() {
      const start = (state.page - 1) * state.perPage;
      const end = start + state.perPage;
      const pageMembers = state.filteredMembers.slice(start, end);

      if (pageMembers.length === 0) {
        elements.memberTableBody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <h3 class="empty-title">No members found</h3>
                <p class="empty-text">Try adjusting your search or filter</p>
              </div>
            </td>
          </tr>
        `;
      } else {
        elements.memberTableBody.innerHTML = pageMembers.map(renderMemberRow).join('');
      }

      // Update info
      const total = state.filteredMembers.length;
      elements.tableInfo.textContent = `Showing ${start + 1}-${Math.min(end, total)} of ${total} members`;
      elements.memberCount.textContent = `${state.members.length} total members`;

      // Render pagination
      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(state.filteredMembers.length / state.perPage);
      if (totalPages <= 1) {
        elements.pagination.innerHTML = '';
        return;
      }

      let html = '';

      // Previous
      html += `<button class="pagination-btn" ${state.page === 1 ? 'disabled' : ''} onclick="goToPage(${state.page - 1})">←</button>`;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= state.page - 1 && i <= state.page + 1)) {
          html += `<button class="pagination-btn ${i === state.page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === state.page - 2 || i === state.page + 2) {
          html += `<span class="pagination-btn">...</span>`;
        }
      }

      // Next
      html += `<button class="pagination-btn" ${state.page === totalPages ? 'disabled' : ''} onclick="goToPage(${state.page + 1})">→</button>`;

      elements.pagination.innerHTML = html;
    }

    function renderAttentionBar() {
      const now = new Date();
      const expiringSoon = state.members.filter(m => {
        if (!m.expires_at || m.status === 'expired') return false;
        const daysUntil = Math.ceil((new Date(m.expires_at) - now) / (1000 * 60 * 60 * 24));
        return daysUntil <= 30 && daysUntil > 0;
      });
      const expired = state.members.filter(m => m.status === 'expired');

      const items = [];
      if (expiringSoon.length > 0) {
        items.push(`<span class="attention-item" onclick="filterBy('expiring')">${expiringSoon.length} expiring within 30 days</span>`);
      }
      if (expired.length > 0) {
        items.push(`<span class="attention-item" onclick="filterBy('expired')">${expired.length} expired</span>`);
      }

      if (items.length === 0) {
        elements.attentionBar.classList.add('hidden');
      } else {
        elements.attentionBar.classList.remove('hidden');
        elements.attentionItems.innerHTML = items.join('');
      }
    }

    // ===========================================
    // Filter, Sort, Search
    // ===========================================

    function filterMembers() {
      let filtered = [...state.members];

      // Apply filter
      if (state.currentFilter === 'active') {
        filtered = filtered.filter(m => m.status === 'active');
      } else if (state.currentFilter === 'expired') {
        filtered = filtered.filter(m => m.status === 'expired');
      } else if (state.currentFilter === 'pending') {
        filtered = filtered.filter(m => m.status === 'pending');
      } else if (state.currentFilter === 'expiring') {
        const now = new Date();
        filtered = filtered.filter(m => {
          if (!m.expires_at || m.status !== 'active') return false;
          const daysUntil = Math.ceil((new Date(m.expires_at) - now) / (1000 * 60 * 60 * 24));
          return daysUntil <= 30 && daysUntil > 0;
        });
      }

      // Apply search
      if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(m => {
          const searchable = [
            m.first_name,
            m.last_name,
            m.email,
            m.phone,
            m.tier_name
          ].filter(Boolean).join(' ').toLowerCase();
          return searchable.includes(query);
        });
      }

      // Apply sort
      filtered.sort((a, b) => {
        let aVal = a[state.sortColumn] || '';
        let bVal = b[state.sortColumn] || '';

        if (state.sortColumn === 'name') {
          aVal = `${a.first_name || ''} ${a.last_name || ''}`;
          bVal = `${b.first_name || ''} ${b.last_name || ''}`;
        }

        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return state.sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return state.sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      state.filteredMembers = filtered;
      state.page = 1;
      renderTable();
    }

    function filterBy(filter) {
      state.currentFilter = filter;

      // Update filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });

      filterMembers();
    }

    function sortBy(column) {
      if (state.sortColumn === column) {
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortColumn = column;
        state.sortDirection = 'asc';
      }

      // Update header styling
      document.querySelectorAll('.data-table th').forEach(th => {
        th.classList.toggle('sorted', th.dataset.sort === column);
        const icon = th.querySelector('.sort-icon');
        if (icon) {
          icon.textContent = th.dataset.sort === column
            ? (state.sortDirection === 'asc' ? '↑' : '↓')
            : '↕';
        }
      });

      filterMembers();
    }

    function goToPage(page) {
      state.page = page;
      renderTable();
    }

    // ===========================================
    // Command Palette
    // ===========================================

    function openCommandPalette() {
      elements.commandPalette.classList.add('open');
      elements.commandBackdrop.classList.add('open');
      elements.commandInput.value = '';
      elements.commandInput.focus();
      renderCommandResults('');
    }

    function closeCommandPalette() {
      elements.commandPalette.classList.remove('open');
      elements.commandBackdrop.classList.remove('open');
    }

    function renderCommandResults(query) {
      const lowerQuery = query.toLowerCase();

      // Search members
      const matchingMembers = state.members
        .filter(m => {
          const name = `${m.first_name || ''} ${m.last_name || ''}`.toLowerCase();
          const email = (m.email || '').toLowerCase();
          return name.includes(lowerQuery) || email.includes(lowerQuery);
        })
        .slice(0, 5);

      // Actions
      const actions = [
        { title: 'Add new member', subtitle: 'Create a new member record', action: 'addMember' },
        { title: 'Export members', subtitle: 'Download CSV of all members', action: 'exportMembers' },
        { title: 'Import members', subtitle: 'Upload CSV file', action: 'importMembers' },
      ].filter(a => a.title.toLowerCase().includes(lowerQuery));

      let html = '';

      if (matchingMembers.length > 0) {
        html += '<div class="command-section">Members</div>';
        matchingMembers.forEach(m => {
          html += `
            <div class="command-item" onclick="openMemberDetail('${m.id}'); closeCommandPalette();">
              <div class="member-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                ${getInitials(m.first_name, m.last_name)}
              </div>
              <div class="command-item-text">
                <div class="command-item-title">${m.first_name || ''} ${m.last_name || ''}</div>
                <div class="command-item-subtitle">${m.email || ''}</div>
              </div>
            </div>
          `;
        });
      }

      if (actions.length > 0) {
        html += '<div class="command-section">Actions</div>';
        actions.forEach(a => {
          html += `
            <div class="command-item" onclick="executeAction('${a.action}'); closeCommandPalette();">
              <svg class="command-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              <div class="command-item-text">
                <div class="command-item-title">${a.title}</div>
                <div class="command-item-subtitle">${a.subtitle}</div>
              </div>
            </div>
          `;
        });
      }

      if (html === '') {
        html = '<div class="empty-state" style="padding: 2rem;"><p>No results found</p></div>';
      }

      elements.commandResults.innerHTML = html;
    }

    function executeAction(action) {
      switch (action) {
        case 'addMember':
          showToast('Add member dialog coming soon', 'info');
          break;
        case 'exportMembers':
          exportToCSV();
          break;
        case 'importMembers':
          showToast('Import dialog coming soon', 'info');
          break;
      }
    }

    // ===========================================
    // Export
    // ===========================================

    function exportToCSV() {
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Status', 'Tier', 'Joined', 'Expires'];
      const rows = state.filteredMembers.map(m => [
        m.first_name || '',
        m.last_name || '',
        m.email || '',
        m.phone || '',
        m.status || '',
        m.tier_name || '',
        m.created_at ? new Date(m.created_at).toISOString().split('T')[0] : '',
        m.expires_at ? new Date(m.expires_at).toISOString().split('T')[0] : ''
      ]);

      const csv = [
        headers.join(','),
        ...rows.map(r => r.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `members-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast(`Exported ${state.filteredMembers.length} members`, 'success');
    }

    // ===========================================
    // Add Member Modal
    // ===========================================

    function openAddMemberModal() {
      elements.addMemberModal.classList.add('open');
      elements.addMemberBackdrop.classList.add('open');
      elements.addMemberForm.reset();
      state.ignoreDuplicates = false;
      state.duplicateFound = null;
      document.getElementById('duplicateWarning').style.display = 'none';
      populateTierSelect();
    }

    function closeAddMemberModal() {
      elements.addMemberModal.classList.remove('open');
      elements.addMemberBackdrop.classList.remove('open');
    }

    function populateTierSelect() {
      const select = document.getElementById('tierSelect');
      select.innerHTML = '<option value="">Select tier...</option>';
      state.tiers.forEach(tier => {
        select.innerHTML += `<option value="${tier.id}">${tier.name}</option>`;
      });
    }

    async function handleAddMember(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const memberData = Object.fromEntries(formData);

      // Remove empty values
      Object.keys(memberData).forEach(key => {
        if (!memberData[key]) delete memberData[key];
      });

      try {
        await createMember(memberData);
        showToast('Member added successfully', 'success');
        closeAddMemberModal();
        // Refresh members list
        state.members = await fetchMembers();
        filterMembers();
        renderAttentionBar();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // ===========================================
    // Import CSV Modal
    // ===========================================

    function openImportModal() {
      elements.importModal.classList.add('open');
      elements.importBackdrop.classList.add('open');
      resetImport();
    }

    function closeImportModal() {
      elements.importModal.classList.remove('open');
      elements.importBackdrop.classList.remove('open');
      resetImport();
    }

    function resetImport() {
      state.importData = null;
      state.importMapping = {};
      document.getElementById('importDropzone').style.display = 'block';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('importConfirmBtn').disabled = true;
      document.getElementById('importFileInput').value = '';
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length < 2) return { headers: [], rows: [] };

      // Parse headers
      const headers = parseCSVLine(lines[0]);
      const rows = lines.slice(1).map(line => parseCSVLine(line));

      return { headers, rows };
    }

    function parseCSVLine(line) {
      const result = [];
      let cell = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(cell.trim());
          cell = '';
        } else {
          cell += char;
        }
      }
      result.push(cell.trim());
      return result;
    }

    function handleFileSelect(file) {
      if (!file || !file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const { headers, rows } = parseCSV(text);

        if (headers.length === 0 || rows.length === 0) {
          showToast('CSV file is empty or invalid', 'error');
          return;
        }

        state.importData = { headers, rows };
        renderImportPreview();
      };
      reader.readAsText(file);
    }

    function renderImportPreview() {
      const { headers, rows } = state.importData;

      // Hide dropzone, show preview
      document.getElementById('importDropzone').style.display = 'none';
      document.getElementById('importPreview').style.display = 'block';
      document.getElementById('importPreviewCount').textContent = `${rows.length} rows`;

      // Render preview table header
      const headEl = document.getElementById('importPreviewHead');
      headEl.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

      // Render first 5 rows
      const bodyEl = document.getElementById('importPreviewBody');
      const previewRows = rows.slice(0, 5);
      bodyEl.innerHTML = previewRows.map(row =>
        `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`
      ).join('');

      // Render column mapping
      const knownFields = [
        { key: 'first_name', label: 'First Name' },
        { key: 'last_name', label: 'Last Name' },
        { key: 'email', label: 'Email' },
        { key: 'phone', label: 'Phone' },
        { key: 'status', label: 'Status' },
        { key: 'expires_at', label: 'Expiration Date' },
        { key: 'address', label: 'Address' },
        { key: 'city', label: 'City' },
        { key: 'state', label: 'State' },
        { key: 'zip', label: 'Zip' }
      ];

      // Auto-detect mappings
      headers.forEach((header, idx) => {
        const headerLower = header.toLowerCase().replace(/[^a-z]/g, '');
        for (const field of knownFields) {
          const fieldLower = field.label.toLowerCase().replace(/[^a-z]/g, '');
          if (headerLower.includes(fieldLower) || fieldLower.includes(headerLower)) {
            state.importMapping[idx] = field.key;
            break;
          }
        }
      });

      const mappingEl = document.getElementById('importMappingRows');
      mappingEl.innerHTML = headers.map((header, idx) => `
        <div class="import-mapping-row">
          <span>${header}</span>
          <span class="import-mapping-arrow">→</span>
          <select class="form-select" onchange="state.importMapping[${idx}] = this.value">
            <option value="">Skip this column</option>
            ${knownFields.map(f => `
              <option value="${f.key}" ${state.importMapping[idx] === f.key ? 'selected' : ''}>${f.label}</option>
            `).join('')}
          </select>
        </div>
      `).join('');

      // Enable import button if we have email mapped
      updateImportButton();
    }

    function updateImportButton() {
      const hasEmail = Object.values(state.importMapping).includes('email');
      document.getElementById('importConfirmBtn').disabled = !hasEmail;
    }

    async function handleImport() {
      if (!state.importData) return;

      const { headers, rows } = state.importData;
      const members = rows.map(row => {
        const member = {};
        headers.forEach((header, idx) => {
          const fieldKey = state.importMapping[idx];
          if (fieldKey && row[idx]) {
            member[fieldKey] = row[idx];
          }
        });
        return member;
      }).filter(m => m.email); // Only import rows with email

      if (members.length === 0) {
        showToast('No valid members to import', 'error');
        return;
      }

      try {
        const result = await importMembers(members);
        showToast(`Imported ${result.imported || members.length} members`, 'success');
        closeImportModal();
        // Refresh members list
        state.members = await fetchMembers();
        filterMembers();
        renderAttentionBar();
      } catch (error) {
        showToast('Import failed: ' + error.message, 'error');
      }
    }

    // ===========================================
    // Member Detail Slide-over
    // ===========================================

    function openMemberDetail(id) {
      const member = state.members.find(m => m.id === id || m.id === parseInt(id));
      if (!member) {
        showToast('Member not found', 'error');
        return;
      }

      state.selectedMember = member;

      // Update header
      document.getElementById('detailAvatar').textContent = getInitials(member.first_name, member.last_name);
      document.getElementById('detailName').textContent = `${member.first_name || ''} ${member.last_name || ''}`;
      document.getElementById('detailEmail').textContent = member.email || '';

      const statusEl = document.getElementById('detailStatus');
      const statusClass = getStatusClass(member.status, member.expires_at);
      const statusLabel = getStatusLabel(member.status, member.expires_at);
      statusEl.className = `status-badge ${statusClass}`;
      statusEl.textContent = statusLabel;

      // Update profile tab
      document.getElementById('detail-email').textContent = member.email || '-';
      document.getElementById('detail-phone').textContent = member.phone || '-';
      document.getElementById('detail-address').textContent = member.address || '-';
      document.getElementById('detail-city-state').textContent =
        [member.city, member.state].filter(Boolean).join(', ') || '-';
      document.getElementById('detail-tier').textContent = member.tier_name || '-';
      document.getElementById('detail-member-status').textContent = member.status || '-';
      document.getElementById('detail-joined').textContent = formatDate(member.created_at);
      document.getElementById('detail-expires').textContent = formatDate(member.expires_at);

      // Reset to profile tab
      switchTab('profile');

      // Render timeline
      renderMemberTimeline(member);

      // Open the panel
      elements.memberDetailPanel.classList.add('open');
      elements.memberDetailBackdrop.classList.add('open');
    }

    function closeMemberDetail() {
      elements.memberDetailPanel.classList.remove('open');
      elements.memberDetailBackdrop.classList.remove('open');
      state.selectedMember = null;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.member-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      document.querySelectorAll('.member-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
      });
    }

    function renderMemberTimeline(member) {
      const timelineEl = document.getElementById('memberTimeline');
      const events = [];

      // Add creation event
      if (member.created_at) {
        events.push({
          date: member.created_at,
          content: 'Member record created'
        });
      }

      // Sort by date descending
      events.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (events.length === 0) {
        timelineEl.innerHTML = '<p style="color: var(--text-secondary); font-size: var(--text-sm);">No activity recorded yet.</p>';
        return;
      }

      timelineEl.innerHTML = events.map(event => `
        <div class="timeline-item">
          <div class="timeline-item-date">${formatDate(event.date)}</div>
          <div class="timeline-item-content">${event.content}</div>
        </div>
      `).join('');
    }

    async function addNote() {
      if (!state.selectedMember) return;

      const noteText = document.getElementById('newNoteText').value.trim();
      if (!noteText) {
        showToast('Please enter a note', 'error');
        return;
      }

      // For now, just show the note locally (would save to API in full implementation)
      const notesEl = document.getElementById('memberNotes');
      const noteCard = document.createElement('div');
      noteCard.className = 'note-card';
      noteCard.innerHTML = `
        <div class="note-card-header">
          <span class="note-card-author">Admin</span>
          <span class="note-card-date">${formatDate(new Date().toISOString())}</span>
        </div>
        <div class="note-card-content">${noteText}</div>
      `;

      if (notesEl.querySelector('p')) {
        notesEl.innerHTML = '';
      }
      notesEl.insertBefore(noteCard, notesEl.firstChild);
      document.getElementById('newNoteText').value = '';
      showToast('Note added', 'success');
    }

    async function confirmDeleteMember() {
      if (!state.selectedMember) return;

      const confirmed = confirm(`Are you sure you want to delete ${state.selectedMember.first_name} ${state.selectedMember.last_name}? This cannot be undone.`);
      if (!confirmed) return;

      const success = await deleteMember(state.selectedMember.id);
      if (success) {
        showToast('Member deleted', 'success');
        closeMemberDetail();
        // Refresh members list
        state.members = await fetchMembers();
        filterMembers();
        renderAttentionBar();
      } else {
        showToast('Failed to delete member', 'error');
      }
    }

    // ===========================================
    // Inline Editing
    // ===========================================

    function setupInlineEditing() {
      // Detail panel inline editing
      document.querySelectorAll('.detail-item-value[data-field]').forEach(el => {
        el.addEventListener('click', (e) => {
          if (el.classList.contains('editing')) return;
          if (!state.selectedMember) return;

          const field = el.dataset.field;
          const currentValue = state.selectedMember[field] || '';

          el.classList.add('editing');
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-input';
          input.value = currentValue;
          input.style.margin = '0';
          input.style.padding = 'var(--space-1) var(--space-2)';

          const originalContent = el.textContent;
          el.textContent = '';
          el.appendChild(input);
          input.focus();
          input.select();

          const saveEdit = async () => {
            const newValue = input.value.trim();
            el.classList.remove('editing');

            if (newValue !== currentValue) {
              const success = await updateMember(state.selectedMember.id, { [field]: newValue });
              if (success) {
                state.selectedMember[field] = newValue;
                // Also update in members array
                const member = state.members.find(m => m.id === state.selectedMember.id);
                if (member) member[field] = newValue;
                renderTable();
              }
            }

            el.textContent = newValue || '-';
          };

          input.addEventListener('blur', saveEdit);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              input.blur();
            } else if (e.key === 'Escape') {
              el.classList.remove('editing');
              el.textContent = originalContent;
            }
          });
        });
      });
    }

    // ===========================================
    // Toast Notifications
    // ===========================================

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer; padding: 4px; color: var(--gray-400);">×</button>
      `;
      elements.toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    // ===========================================
    // Event Listeners
    // ===========================================

    // Search input
    elements.searchInput.addEventListener('input', (e) => {
      state.searchQuery = e.target.value;
      filterMembers();
    });

    // Command palette keyboard shortcut
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openCommandPalette();
      }
      if (e.key === 'Escape') {
        closeCommandPalette();
      }
    });

    // Command palette backdrop click
    elements.commandBackdrop.addEventListener('click', closeCommandPalette);

    // Command palette input
    elements.commandInput.addEventListener('input', (e) => {
      renderCommandResults(e.target.value);
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => filterBy(btn.dataset.filter));
    });

    // Sort headers
    document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
      th.addEventListener('click', () => sortBy(th.dataset.sort));
    });

    // Export button
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);

    // Add member button
    document.getElementById('addMemberBtn').addEventListener('click', openAddMemberModal);

    // Import button
    document.getElementById('importBtn').addEventListener('click', openImportModal);

    // Modal backdrop clicks
    elements.addMemberBackdrop.addEventListener('click', closeAddMemberModal);
    elements.importBackdrop.addEventListener('click', closeImportModal);
    elements.memberDetailBackdrop.addEventListener('click', closeMemberDetail);

    // Duplicate check on email/phone input
    document.getElementById('newMemberEmail').addEventListener('blur', checkForDuplicates);
    document.getElementById('newMemberPhone').addEventListener('blur', checkForDuplicates);

    // Import dropzone
    const dropzone = document.getElementById('importDropzone');
    const fileInput = document.getElementById('importFileInput');

    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    // Member detail tabs
    document.querySelectorAll('.member-tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Escape key to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAddMemberModal();
        closeImportModal();
        closeMemberDetail();
      }
    });

    // ===========================================
    // Fuzzy Search (Enhanced)
    // ===========================================

    function fuzzyMatch(text, query) {
      if (!text || !query) return false;
      const textLower = text.toLowerCase();
      const queryLower = query.toLowerCase();

      // Exact substring match
      if (textLower.includes(queryLower)) return true;

      // Fuzzy match - all characters must appear in order
      let queryIdx = 0;
      for (let i = 0; i < textLower.length && queryIdx < queryLower.length; i++) {
        if (textLower[i] === queryLower[queryIdx]) {
          queryIdx++;
        }
      }
      return queryIdx === queryLower.length;
    }

    // ===========================================
    // Initialize
    // ===========================================

    async function init() {
      // Fetch data in parallel
      const [members, tiers] = await Promise.all([
        fetchMembers(),
        fetchTiers()
      ]);

      state.members = members;
      state.tiers = tiers;
      state.loading = false;

      filterMembers();
      renderAttentionBar();
      setupInlineEditing();

      // Set up command palette member search
      elements.searchInput.addEventListener('focus', () => {
        // Focus enhances with larger search if needed
      });
    }

    init();
  </script>
</body>
</html>
